<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>運用方法（案） | Teach English</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="Example website powered by Vuepress and Netlify CMS">
    
    <link rel="preload" href="/assets/css/0.styles.84741abc.css" as="style"><link rel="preload" href="/assets/js/app.4d20ba07.js" as="script"><link rel="preload" href="/assets/js/2.7e8b5cf7.js" as="script"><link rel="preload" href="/assets/js/81.a44b619a.js" as="script"><link rel="prefetch" href="/assets/js/10.01ee0055.js"><link rel="prefetch" href="/assets/js/100.ac2360a0.js"><link rel="prefetch" href="/assets/js/101.1b9d314f.js"><link rel="prefetch" href="/assets/js/102.1ce1ea5f.js"><link rel="prefetch" href="/assets/js/103.33ba6d9a.js"><link rel="prefetch" href="/assets/js/104.1581ad88.js"><link rel="prefetch" href="/assets/js/105.f5c2863a.js"><link rel="prefetch" href="/assets/js/106.8645afc3.js"><link rel="prefetch" href="/assets/js/107.0ee3e496.js"><link rel="prefetch" href="/assets/js/108.d48369bb.js"><link rel="prefetch" href="/assets/js/109.ebbceab3.js"><link rel="prefetch" href="/assets/js/11.4c64e210.js"><link rel="prefetch" href="/assets/js/110.222907f7.js"><link rel="prefetch" href="/assets/js/111.c2a28b3d.js"><link rel="prefetch" href="/assets/js/112.c364bff4.js"><link rel="prefetch" href="/assets/js/113.6e696a6f.js"><link rel="prefetch" href="/assets/js/114.24440118.js"><link rel="prefetch" href="/assets/js/115.5e3f3f54.js"><link rel="prefetch" href="/assets/js/116.d329a7e2.js"><link rel="prefetch" href="/assets/js/117.db300340.js"><link rel="prefetch" href="/assets/js/118.2f708954.js"><link rel="prefetch" href="/assets/js/119.1bab1b46.js"><link rel="prefetch" href="/assets/js/12.cad825a2.js"><link rel="prefetch" href="/assets/js/120.23fc318b.js"><link rel="prefetch" href="/assets/js/121.4a89dfcb.js"><link rel="prefetch" href="/assets/js/122.56b8c4f3.js"><link rel="prefetch" href="/assets/js/123.2c94ca29.js"><link rel="prefetch" href="/assets/js/124.66f8cc70.js"><link rel="prefetch" href="/assets/js/125.e8177153.js"><link rel="prefetch" href="/assets/js/126.656f7b1b.js"><link rel="prefetch" href="/assets/js/127.c74af4c0.js"><link rel="prefetch" href="/assets/js/128.ca7e246d.js"><link rel="prefetch" href="/assets/js/129.cae2e6c3.js"><link rel="prefetch" href="/assets/js/13.59f438ee.js"><link rel="prefetch" href="/assets/js/130.386bf4df.js"><link rel="prefetch" href="/assets/js/131.b874fad5.js"><link rel="prefetch" href="/assets/js/132.bcf6f255.js"><link rel="prefetch" href="/assets/js/133.085e084f.js"><link rel="prefetch" href="/assets/js/134.c6765eaf.js"><link rel="prefetch" href="/assets/js/135.a30bdba0.js"><link rel="prefetch" href="/assets/js/136.8662ba72.js"><link rel="prefetch" href="/assets/js/137.99dfae7a.js"><link rel="prefetch" href="/assets/js/138.d6002ed6.js"><link rel="prefetch" href="/assets/js/139.94a0ad48.js"><link rel="prefetch" href="/assets/js/14.aa78a9cb.js"><link rel="prefetch" href="/assets/js/140.36baf76c.js"><link rel="prefetch" href="/assets/js/141.08b885ea.js"><link rel="prefetch" href="/assets/js/142.5c9a067b.js"><link rel="prefetch" href="/assets/js/143.7618c263.js"><link rel="prefetch" href="/assets/js/144.32d05012.js"><link rel="prefetch" href="/assets/js/145.23d20978.js"><link rel="prefetch" href="/assets/js/146.cc85a275.js"><link rel="prefetch" href="/assets/js/147.def435f1.js"><link rel="prefetch" href="/assets/js/148.eae48fc1.js"><link rel="prefetch" href="/assets/js/149.99b81cb1.js"><link rel="prefetch" href="/assets/js/15.6c247b3d.js"><link rel="prefetch" href="/assets/js/150.92a1f630.js"><link rel="prefetch" href="/assets/js/151.a165f09f.js"><link rel="prefetch" href="/assets/js/152.b8d076c5.js"><link rel="prefetch" href="/assets/js/153.1cddaa3f.js"><link rel="prefetch" href="/assets/js/154.6c624fbb.js"><link rel="prefetch" href="/assets/js/155.b05382be.js"><link rel="prefetch" href="/assets/js/156.95493061.js"><link rel="prefetch" href="/assets/js/157.b38c1a4d.js"><link rel="prefetch" href="/assets/js/158.8d5731e6.js"><link rel="prefetch" href="/assets/js/159.03254dc5.js"><link rel="prefetch" href="/assets/js/16.a6c2d532.js"><link rel="prefetch" href="/assets/js/160.c42ca845.js"><link rel="prefetch" href="/assets/js/161.4d871e86.js"><link rel="prefetch" href="/assets/js/162.8a57206f.js"><link rel="prefetch" href="/assets/js/163.ba09db4f.js"><link rel="prefetch" href="/assets/js/164.f41d27e0.js"><link rel="prefetch" href="/assets/js/165.82108bf8.js"><link rel="prefetch" href="/assets/js/166.06cabfc4.js"><link rel="prefetch" href="/assets/js/167.dca7c062.js"><link rel="prefetch" href="/assets/js/168.87290221.js"><link rel="prefetch" href="/assets/js/169.1ae5c929.js"><link rel="prefetch" href="/assets/js/17.b4b7332a.js"><link rel="prefetch" href="/assets/js/170.1a8e2481.js"><link rel="prefetch" href="/assets/js/171.8416d4c9.js"><link rel="prefetch" href="/assets/js/172.51cb4363.js"><link rel="prefetch" href="/assets/js/173.46d98303.js"><link rel="prefetch" href="/assets/js/174.2011bb6e.js"><link rel="prefetch" href="/assets/js/175.c303e2f6.js"><link rel="prefetch" href="/assets/js/176.6cb3982e.js"><link rel="prefetch" href="/assets/js/177.14667589.js"><link rel="prefetch" href="/assets/js/178.1caf3d35.js"><link rel="prefetch" href="/assets/js/179.ae065b43.js"><link rel="prefetch" href="/assets/js/18.6ea24866.js"><link rel="prefetch" href="/assets/js/180.f65b132d.js"><link rel="prefetch" href="/assets/js/181.b6bf0313.js"><link rel="prefetch" href="/assets/js/182.4e944307.js"><link rel="prefetch" href="/assets/js/183.8d321780.js"><link rel="prefetch" href="/assets/js/184.01f97247.js"><link rel="prefetch" href="/assets/js/185.deea1e0c.js"><link rel="prefetch" href="/assets/js/186.6a0e1246.js"><link rel="prefetch" href="/assets/js/187.facd6f8a.js"><link rel="prefetch" href="/assets/js/188.3ed56c82.js"><link rel="prefetch" href="/assets/js/189.6681b39f.js"><link rel="prefetch" href="/assets/js/19.2120e2fc.js"><link rel="prefetch" href="/assets/js/190.d8e21bd0.js"><link rel="prefetch" href="/assets/js/191.b462d0f5.js"><link rel="prefetch" href="/assets/js/192.abdcb3c4.js"><link rel="prefetch" href="/assets/js/193.9d738596.js"><link rel="prefetch" href="/assets/js/194.c14feb3f.js"><link rel="prefetch" href="/assets/js/195.e408656b.js"><link rel="prefetch" href="/assets/js/196.8a7d4ac4.js"><link rel="prefetch" href="/assets/js/197.941a15cd.js"><link rel="prefetch" href="/assets/js/198.f76dedcd.js"><link rel="prefetch" href="/assets/js/199.cc1e4f47.js"><link rel="prefetch" href="/assets/js/20.aac16089.js"><link rel="prefetch" href="/assets/js/200.19067b7a.js"><link rel="prefetch" href="/assets/js/201.fe1e6fc0.js"><link rel="prefetch" href="/assets/js/202.6573718a.js"><link rel="prefetch" href="/assets/js/203.faa3e971.js"><link rel="prefetch" href="/assets/js/21.9490af01.js"><link rel="prefetch" href="/assets/js/22.4d6f493e.js"><link rel="prefetch" href="/assets/js/23.3f1f5159.js"><link rel="prefetch" href="/assets/js/24.8b8ca71d.js"><link rel="prefetch" href="/assets/js/25.20b7f676.js"><link rel="prefetch" href="/assets/js/26.f5458331.js"><link rel="prefetch" href="/assets/js/27.e00d0785.js"><link rel="prefetch" href="/assets/js/28.287295ad.js"><link rel="prefetch" href="/assets/js/29.b6532611.js"><link rel="prefetch" href="/assets/js/3.1716a765.js"><link rel="prefetch" href="/assets/js/30.176bc4c6.js"><link rel="prefetch" href="/assets/js/31.117f5833.js"><link rel="prefetch" href="/assets/js/32.9f960f19.js"><link rel="prefetch" href="/assets/js/33.e1fc54fa.js"><link rel="prefetch" href="/assets/js/34.8ddd15a3.js"><link rel="prefetch" href="/assets/js/35.d598ac70.js"><link rel="prefetch" href="/assets/js/36.24c88b2f.js"><link rel="prefetch" href="/assets/js/37.8a11ca9e.js"><link rel="prefetch" href="/assets/js/38.e8abfc5c.js"><link rel="prefetch" href="/assets/js/39.750bf34a.js"><link rel="prefetch" href="/assets/js/4.d7407e22.js"><link rel="prefetch" href="/assets/js/40.b0807d6d.js"><link rel="prefetch" href="/assets/js/41.549fd4f0.js"><link rel="prefetch" href="/assets/js/42.4e7fe891.js"><link rel="prefetch" href="/assets/js/43.7e1a9b5b.js"><link rel="prefetch" href="/assets/js/44.cf2513ca.js"><link rel="prefetch" href="/assets/js/45.4c6cea7a.js"><link rel="prefetch" href="/assets/js/46.8d6ee3c0.js"><link rel="prefetch" href="/assets/js/47.1757c52d.js"><link rel="prefetch" href="/assets/js/48.3c1d48cd.js"><link rel="prefetch" href="/assets/js/49.646189b6.js"><link rel="prefetch" href="/assets/js/5.0fb010b4.js"><link rel="prefetch" href="/assets/js/50.c34b7013.js"><link rel="prefetch" href="/assets/js/51.68386b75.js"><link rel="prefetch" href="/assets/js/52.82baaf83.js"><link rel="prefetch" href="/assets/js/53.1e46e38a.js"><link rel="prefetch" href="/assets/js/54.0b73420b.js"><link rel="prefetch" href="/assets/js/55.2b0837a5.js"><link rel="prefetch" href="/assets/js/56.89ad4a27.js"><link rel="prefetch" href="/assets/js/57.f6526128.js"><link rel="prefetch" href="/assets/js/58.9737ba80.js"><link rel="prefetch" href="/assets/js/59.fde446bd.js"><link rel="prefetch" href="/assets/js/6.fdf4a7c6.js"><link rel="prefetch" href="/assets/js/60.4209d0e8.js"><link rel="prefetch" href="/assets/js/61.e4d59452.js"><link rel="prefetch" href="/assets/js/62.32b84b3f.js"><link rel="prefetch" href="/assets/js/63.134d21cd.js"><link rel="prefetch" href="/assets/js/64.36a0948e.js"><link rel="prefetch" href="/assets/js/65.1790afd6.js"><link rel="prefetch" href="/assets/js/66.f4b2d9c3.js"><link rel="prefetch" href="/assets/js/67.51970eaf.js"><link rel="prefetch" href="/assets/js/68.01449987.js"><link rel="prefetch" href="/assets/js/69.efc049f6.js"><link rel="prefetch" href="/assets/js/7.d9820b1b.js"><link rel="prefetch" href="/assets/js/70.1638b004.js"><link rel="prefetch" href="/assets/js/71.82e6e817.js"><link rel="prefetch" href="/assets/js/72.e84448c7.js"><link rel="prefetch" href="/assets/js/73.7fdd9182.js"><link rel="prefetch" href="/assets/js/74.1e8a3913.js"><link rel="prefetch" href="/assets/js/75.5e54c05d.js"><link rel="prefetch" href="/assets/js/76.b542b34e.js"><link rel="prefetch" href="/assets/js/77.f23ac509.js"><link rel="prefetch" href="/assets/js/78.a8205009.js"><link rel="prefetch" href="/assets/js/79.2790fe7b.js"><link rel="prefetch" href="/assets/js/8.94221484.js"><link rel="prefetch" href="/assets/js/80.86f9431e.js"><link rel="prefetch" href="/assets/js/82.44b07629.js"><link rel="prefetch" href="/assets/js/83.ea9a72b8.js"><link rel="prefetch" href="/assets/js/84.9b7e3a6e.js"><link rel="prefetch" href="/assets/js/85.f7705353.js"><link rel="prefetch" href="/assets/js/86.9cd3e28a.js"><link rel="prefetch" href="/assets/js/87.1f41e79d.js"><link rel="prefetch" href="/assets/js/88.beb49e83.js"><link rel="prefetch" href="/assets/js/89.b45271ab.js"><link rel="prefetch" href="/assets/js/9.1f564f7c.js"><link rel="prefetch" href="/assets/js/90.f498a210.js"><link rel="prefetch" href="/assets/js/91.9560dc56.js"><link rel="prefetch" href="/assets/js/92.20aa3420.js"><link rel="prefetch" href="/assets/js/93.bdc9fb1b.js"><link rel="prefetch" href="/assets/js/94.28d6b294.js"><link rel="prefetch" href="/assets/js/95.83c5dd12.js"><link rel="prefetch" href="/assets/js/96.6dc26c95.js"><link rel="prefetch" href="/assets/js/97.f476bd8e.js"><link rel="prefetch" href="/assets/js/98.b6e31352.js"><link rel="prefetch" href="/assets/js/99.7000f232.js">
    <link rel="stylesheet" href="/assets/css/0.styles.84741abc.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Teach English</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/about/" class="nav-link">
  About
</a></div><div class="nav-item"><a href="/categories/" class="nav-link">
  Categories
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/about/" class="nav-link">
  About
</a></div><div class="nav-item"><a href="/categories/" class="nav-link">
  Categories
</a></div> <!----></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="運用方法-案"><a href="#運用方法-案" class="header-anchor">#</a> 運用方法（案）</h2> <h3 id="概要"><a href="#概要" class="header-anchor">#</a> 概要</h3> <ul><li><p>倉庫から届く出荷済みCSVを新meethに取り込む</p></li> <li><p>出荷済みCSVは2種類あり、</p> <ol><li>shopifyから倉庫に連携された注文を元に生成されたCSV</li> <li>新meethから倉庫に連携された注文を元に生成されたCSV</li></ol></li> <li><p>処理の流れは次の通り</p> <ol><li>#meeth-optsに<code>出荷済CSV</code>が届く</li> <li>production踏み台サーバに<code>出荷済CSV</code>を転送</li> <li>引数に<code>出荷済CSV</code>を指定して取り込みバッチを実行する</li> <li>出荷済注文について顧客名、email、注文内容等を記載したレコードがproduction DBの<code>logizerd_orders</code>テーブルに作成される</li> <li><code>logizerd_orders</code>テーブルからCSVを出力する</li> <li>出力したCSVをsendgridにアップロードする</li> <li>出荷連絡用のテンプレートをセットしてメールを送信する</li></ol></li></ul> <ul><li>Productionの踏み台サーバーにscpにてファイル転送を行う。</li></ul> <p>ファイル名はサンプルです、認識しやすいファイル命名規則を作成してください</p> <div class="language- extra-class"><pre class="language-text"><code>scp ./shipping_data_YYYYMMDD.csv ec2-user@52.199.71.78:~/
</code></pre></div><ul><li>ファイルコピーを行うフォルダーがなければ作成する（エラーになってもいいので実行する）</li></ul> <div class="language- extra-class"><pre class="language-text"><code>mkdir ~/Meeth/logizard_temp/
</code></pre></div><p>ファイルのコピーを行いフォルダー移動を行う</p> <div class="language- extra-class"><pre class="language-text"><code>cp ~/logizard_data.csv ~/Meeth/logizard_temp/ 
cd ~/Meeth/
</code></pre></div><ul><li>取り込みバッチを実行する</li></ul> <div class="language- extra-class"><pre class="language-text"><code>bundle exec rake csv_import:logizard_shipped[./logizard_temp/shipping_data_YYYYMMDD.csv]
</code></pre></div><ul><li>ProductionDBの「logizerd_orders」テーブルからcsvファイルをダウンロード</li></ul> <p>csvの情報からSendGridで発送メール送信に利用するデータを日付（又は レコード）絞り込んで
　ダウンロードを行う。</p> <ul><li><p>SendGridで発送完了メールを送信する。</p></li> <li><p>[管理画面][注文一覧画面]の「発送処理を開始」のCSVダウンロードをクリック、csvファイルをダウンロードする。</p></li></ul> <p>→to_warehouse_20210128233626.csvのようなファイルがダウンロードされる。</p> <ul><li>csvファイルから発送を行う。</li></ul> <p>→meeth様にファイルを連携、ファイルの情報から倉庫出荷を行う。</p> <ul><li><p>発送完了したら、Excelファイルにて発送完了した情報ファイルがいただける。</p></li> <li><p>Shopifyのorder_number（name）などからShopifyのorderのidを取得してロジザードからダウンロードしたExcelのorder_idを書き換える必要がある</p></li></ul> <div class="language- extra-class"><pre class="language-text"><code>    &quot;order&quot;: {
        &quot;id&quot;: 2847216959576,
　       &quot;order_number&quot;: 135526 ←　これから　orderのidをとる
    }
</code></pre></div><p>Excelファイルのorder_numberを新meethのorder.idに変更する orders.shopify_order_idにShopify order{&quot;id&quot;:2847216959576}がはいっている</p> <p>↑上記をかんたんに取れる方法を検証中</p> <p>Shopifyの画面で<code>#135526</code>で検索して詳細を開く→ URLの最後にある数字<code>2847216959576</code>を特定</p> <div class="language- extra-class"><pre class="language-text"><code>select id , shopify_order_id from orders where shopify_order_id = 2847216959576;
</code></pre></div><p>この結果の新Meethのidを</p> <p>発送完了のExcelのA列を差し替える。</p> <ul><li><p>Excelファイルをcsvファイルに変換する　ファイル仕様(UTF-8/LF) カンマ区切りcsv形式に変換</p></li> <li><p>Productionの踏み台サーバーにscpにてファイル転送を行う。</p></li></ul> <p>ファイル名はサンプルです、認識しやすいファイル命名規則を作成してください</p> <div class="language- extra-class"><pre class="language-text"><code>scp ./shipping_data_YYYYMMDD.csv ec2-user@52.199.71.78:~/
</code></pre></div><ul><li>ファイルコピーを行うフォルダーがなければ作成する（エラーになってもいいので実行する）</li></ul> <div class="language- extra-class"><pre class="language-text"><code>mkdir ~/Meeth/logizard_temp/
</code></pre></div><p>ファイルのコピーを行いフォルダー移動を行う</p> <div class="language- extra-class"><pre class="language-text"><code>cp ~/shipping_data_YYYYMMDD.csv ~/Meeth/logizard_temp/ 
cd ~/Meeth/
</code></pre></div><ul><li>取り込みバッチを実行する</li></ul> <div class="language- extra-class"><pre class="language-text"><code>bundle exec rake csv_import:logizard_shipped[./logizard_temp/shipping_data_YYYYMMDD.csv]
</code></pre></div><ul><li>ProductionDBの「logizerd_orders」テーブルからcsvファイルをダウンロード</li></ul> <p>csvの情報からSendGridで発送メール送信に利用するデータを日付（又は レコード）絞り込んで
　ダウンロードを行う。</p> <ul><li>SendGridで発送完了メールを送信する。</li></ul> <h2 id="フロー"><a href="#フロー" class="header-anchor">#</a> フロー</h2> <ol><li>ロジザードから受け取る出荷済みCSVを投入</li> <li>CSVに記載の注文番号に該当する注文に「https://github.com/grrowjp/Meeth/blob/develop/app/services/process_shipping_service.rb」の
「complete」メソッドで行っているのと同等の処理を行う</li> <li>処理した注文番号を出荷済みテーブルにインサートする</li></ol> <p>process_shipping_service.rb complete method</p> <div class="language-ruby extra-class"><pre class="language-ruby"><code>  <span class="token keyword">def</span> <span class="token method-definition"><span class="token function">complete</span></span><span class="token punctuation">(</span>order<span class="token punctuation">,</span> performer<span class="token punctuation">,</span> params<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">unless</span> can_complete<span class="token operator">?</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span>
    ActiveRecord<span class="token double-colon punctuation">::</span>Base<span class="token punctuation">.</span>transaction <span class="token keyword">do</span>
      <span class="token comment"># 割り当て数(allocated_stock)の更新</span>
      order<span class="token punctuation">.</span>order_details<span class="token punctuation">.</span><span class="token keyword">each</span> <span class="token keyword">do</span> <span class="token operator">|</span>order_detail<span class="token operator">|</span>
        product_detail <span class="token operator">=</span> order_detail<span class="token punctuation">.</span>product_detail
        product_detail<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token symbol">allocated_stock</span><span class="token operator">:</span> product_detail<span class="token punctuation">.</span>allocated_stock <span class="token operator">-</span> order_detail<span class="token punctuation">.</span>quantity<span class="token punctuation">)</span>
        product_detail<span class="token punctuation">.</span>product_stock<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token symbol">stock</span><span class="token operator">:</span> product_detail<span class="token punctuation">.</span>product_stock<span class="token punctuation">.</span>stock <span class="token operator">-</span> order_detail<span class="token punctuation">.</span>quantity<span class="token punctuation">)</span>
      <span class="token keyword">end</span>

      <span class="token comment"># 注文の強制更新。ログは吐く。paramsで出荷番号と出荷方法受け取る</span>
      order<span class="token punctuation">.</span>update<span class="token operator">!</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span>
      <span class="token comment"># 注文を入金完了にする</span>
      order<span class="token punctuation">.</span>payment<span class="token punctuation">.</span>capture<span class="token operator">!</span>
      <span class="token comment"># 注文を完了にする</span>
      order<span class="token punctuation">.</span>finished<span class="token operator">!</span>
      <span class="token comment"># 注文を発送完了にする</span>
      order<span class="token punctuation">.</span>shipping_finished<span class="token operator">!</span>
      <span class="token comment"># 注文を発送完了にする</span>
      OrderStatusTrail<span class="token punctuation">.</span>add<span class="token operator">!</span><span class="token punctuation">(</span>order<span class="token punctuation">,</span> order<span class="token punctuation">.</span>payment<span class="token punctuation">,</span> performer<span class="token punctuation">)</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>
</code></pre></div><h2 id="環境"><a href="#環境" class="header-anchor">#</a> 環境</h2> <ul><li>shopify注文データ連携プログラムに準じた利用方法</li> <li>踏み台サーバから実行可能であること</li> <li>ファイルパス指定で取込を実施</li> <li>処理後ファイル削除はしない</li></ul> <h2 id="実行手順"><a href="#実行手順" class="header-anchor">#</a> 実行手順</h2> <div class="language- extra-class"><pre class="language-text"><code># ./tmp/shipped.csv に ロジザードのCSVがある場合
bundle exec rake csv_import:logizard_shipped[./tmp/shipped.csv]
</code></pre></div><h2 id="実装内容"><a href="#実装内容" class="header-anchor">#</a> 実装内容</h2> <ul><li>出荷済みテーブル作成</li> <li>出荷済みテーブルのmigration作成</li></ul> <h2 id="出荷済みcsvサンプル"><a href="#出荷済みcsvサンプル" class="header-anchor">#</a> 出荷済みCSVサンプル</h2> <table><thead><tr><th>ORDER_ID</th> <th>TRACKING_COMPANY</th> <th>TRACKING_NUMBER</th> <th>TRACKING_URL</th></tr></thead> <tbody><tr><td>#135526</td> <td>ヤマト運輸</td> <td>468432438972</td> <td>http://jizen.kuronekoyamato.co.jp/jizen/servlet/crjz.b.NQ0010?id=468432438972</td></tr> <tr><td>#142816</td> <td>ヤマト運輸</td> <td>468431781215</td> <td>http://jizen.kuronekoyamato.co.jp/jizen/servlet/crjz.b.NQ0010?id=468431781215</td></tr> <tr><td>#143346</td> <td>ヤマト運輸</td> <td>468431789350</td> <td>http://jizen.kuronekoyamato.co.jp/jizen/servlet/crjz.b.NQ0010?id=468431789350</td></tr> <tr><td>#147893</td> <td>ヤマト運輸</td> <td>438002705722</td> <td>http://jizen.kuronekoyamato.co.jp/jizen/servlet/crjz.b.NQ0010?id=438002705722</td></tr> <tr><td>#147903</td> <td>ヤマト運輸</td> <td>438002705733</td> <td>http://jizen.kuronekoyamato.co.jp/jizen/servlet/crjz.b.NQ0010?id=438002705733</td></tr></tbody></table> <h2 id="出荷済みテーブル-logizard-orders"><a href="#出荷済みテーブル-logizard-orders" class="header-anchor">#</a> 出荷済みテーブル（logizard_orders）</h2> <p>出荷済み注文及び送り先のユーザーを格納するテーブル</p> <table><thead><tr><th>カラム名</th> <th>データ型</th> <th>NULL許容</th> <th>デフォルト値</th> <th>Key</th> <th>属性</th> <th>説明</th></tr></thead> <tbody><tr><td>id</td> <td>bigint</td> <td>NO</td> <td>NULL</td> <td>PRI</td> <td>auto_increment</td> <td>id</td></tr> <tr><td>customer_id</td> <td>bigint</td> <td>NO</td> <td>NULL</td> <td>MUL</td> <td></td> <td>顧客id:customers.id</td></tr> <tr><td>email</td> <td>varchar(255)</td> <td>YES</td> <td>NULL</td> <td></td> <td></td> <td>メールアドレス:customers.email</td></tr> <tr><td>family_name</td> <td>varchar(255)</td> <td>YES</td> <td>NULL</td> <td></td> <td></td> <td>姓:customers.family_name</td></tr> <tr><td>first_name</td> <td>varchar(255)</td> <td>YES</td> <td>NULL</td> <td></td> <td></td> <td>名:customers.first_name</td></tr> <tr><td>order_id</td> <td>bigint</td> <td>NO</td> <td>NULL</td> <td>MUL</td> <td></td> <td></td></tr> <tr><td>order_address1</td> <td>varchar(255)</td> <td>NO</td> <td>NULL</td> <td></td> <td></td> <td>配送先住所1（市区町村）:order_addresses.address1</td></tr> <tr><td>order_address2</td> <td>varchar(255)</td> <td>NO</td> <td>NULL</td> <td></td> <td></td> <td>配送先住所2（番地以外の住所）:order_addresses.address2</td></tr> <tr><td>order_address3</td> <td>varchar(255)</td> <td>YES</td> <td>NULL</td> <td></td> <td></td> <td>配送先住所3（アパート、部屋番号など）:order_addresses.address3</td></tr> <tr><td>order_company_name</td> <td>varchar(255)</td> <td>YES</td> <td>NULL</td> <td></td> <td></td> <td>配送先会社名:order_addresses.company_name</td></tr> <tr><td>order_family_name</td> <td>varchar(255)</td> <td>NO</td> <td>NULL</td> <td></td> <td></td> <td>配送先姓:order_addresses.family_name</td></tr> <tr><td>order_first_name</td> <td>varchar(255)</td> <td>NO</td> <td>NULL</td> <td></td> <td></td> <td>配送先名:order_addresses.first_name</td></tr> <tr><td>product_detail_id</td> <td>varchar(255)</td> <td>NO</td> <td>NULL</td> <td></td> <td></td> <td>商品詳細ID（商品画像用）</td></tr> <tr><td>product_name</td> <td>varchar(255)</td> <td>NO</td> <td>NULL</td> <td></td> <td></td> <td>商品名:products.name</td></tr> <tr><td>quantity</td> <td>int</td> <td>NO</td> <td>NULL</td> <td></td> <td></td> <td>注文個数:order_details.quantity</td></tr> <tr><td>tracking_company</td> <td>varchar(255)</td> <td>YES</td> <td>NULL</td> <td></td> <td></td> <td>会社名(配送会社名：ヤマトなど)</td></tr> <tr><td>tracking_no</td> <td>text</td> <td>NO</td> <td>NULL</td> <td></td> <td></td> <td></td></tr> <tr><td>tracking_url</td> <td>text</td> <td>NO</td> <td>NULL</td> <td></td> <td></td> <td></td></tr> <tr><td>shipped_at</td> <td>datetime</td> <td>NO</td> <td>NULL</td> <td></td> <td></td> <td>配送日（バッチ実行日）</td></tr> <tr><td>created_at</td> <td>datetime</td> <td>NO</td> <td>NULL</td> <td></td> <td></td> <td>バッチ実行日時</td></tr> <tr><td>updated_at</td> <td>datetime</td> <td>NO</td> <td>NULL</td> <td></td> <td></td> <td>バッチ実行日時</td></tr></tbody></table> <h2 id="注文メールテンプレート-参考"><a href="#注文メールテンプレート-参考" class="header-anchor">#</a> 注文メールテンプレート（参考）</h2> <div class="language- extra-class"><pre class="language-text"><code>&lt;name&gt; or &lt;email address&gt; 様、  

この度はご購入いただき誠にありがとうございます。  
ご注文の商品を発送いたしました。  

下記のご注文内容をご確認ください。ご注文内容の詳細はhttps://meeth.store/ の「マイアカウント&lt;link&gt;」にてご覧頂けます。  

 ＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝

ご注文内容

・ご注文番号： #40555 &lt;link&gt;

・配送先住所： 名前　住所
・配送方法：宅急便

・商品画像　商品名　数量

＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝

※　領収書の発行について
【クレジットカードでお支払いの場合】ご購入いただくと、注文履歴 に印刷可能な領収書が表示されます。

【代金引換の場合】原則、領収書は発行しておりません。配送会社が発行する領収書をご使用ください。
【銀行振り込みの場合】原則、領収書は発行しておりません。お支払い先の銀行が発行する領収書をご使用ください。

※　返品・交換について
原則、返品交換はお受けできません。
不良品、または誤配等の理由により注文商品と異なる商品を納品した場合のみ、商品到着後5営業日以内のご連絡に限り、お受け致します。

このメールのご案内をもって、ご注文は完了となります。

今後ともmeeth storeをよろしくお願い申し上げます。
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.4d20ba07.js" defer></script><script src="/assets/js/2.7e8b5cf7.js" defer></script><script src="/assets/js/81.a44b619a.js" defer></script>
  </body>
</html>
