<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ソースコードの場所について | Teach English</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="Example website powered by Vuepress and Netlify CMS">
    
    <link rel="preload" href="/assets/css/0.styles.84741abc.css" as="style"><link rel="preload" href="/assets/js/app.4d20ba07.js" as="script"><link rel="preload" href="/assets/js/2.7e8b5cf7.js" as="script"><link rel="preload" href="/assets/js/28.287295ad.js" as="script"><link rel="prefetch" href="/assets/js/10.01ee0055.js"><link rel="prefetch" href="/assets/js/100.ac2360a0.js"><link rel="prefetch" href="/assets/js/101.1b9d314f.js"><link rel="prefetch" href="/assets/js/102.1ce1ea5f.js"><link rel="prefetch" href="/assets/js/103.33ba6d9a.js"><link rel="prefetch" href="/assets/js/104.1581ad88.js"><link rel="prefetch" href="/assets/js/105.f5c2863a.js"><link rel="prefetch" href="/assets/js/106.8645afc3.js"><link rel="prefetch" href="/assets/js/107.0ee3e496.js"><link rel="prefetch" href="/assets/js/108.d48369bb.js"><link rel="prefetch" href="/assets/js/109.ebbceab3.js"><link rel="prefetch" href="/assets/js/11.4c64e210.js"><link rel="prefetch" href="/assets/js/110.222907f7.js"><link rel="prefetch" href="/assets/js/111.c2a28b3d.js"><link rel="prefetch" href="/assets/js/112.c364bff4.js"><link rel="prefetch" href="/assets/js/113.6e696a6f.js"><link rel="prefetch" href="/assets/js/114.24440118.js"><link rel="prefetch" href="/assets/js/115.5e3f3f54.js"><link rel="prefetch" href="/assets/js/116.d329a7e2.js"><link rel="prefetch" href="/assets/js/117.db300340.js"><link rel="prefetch" href="/assets/js/118.2f708954.js"><link rel="prefetch" href="/assets/js/119.1bab1b46.js"><link rel="prefetch" href="/assets/js/12.cad825a2.js"><link rel="prefetch" href="/assets/js/120.23fc318b.js"><link rel="prefetch" href="/assets/js/121.4a89dfcb.js"><link rel="prefetch" href="/assets/js/122.56b8c4f3.js"><link rel="prefetch" href="/assets/js/123.2c94ca29.js"><link rel="prefetch" href="/assets/js/124.66f8cc70.js"><link rel="prefetch" href="/assets/js/125.e8177153.js"><link rel="prefetch" href="/assets/js/126.656f7b1b.js"><link rel="prefetch" href="/assets/js/127.c74af4c0.js"><link rel="prefetch" href="/assets/js/128.ca7e246d.js"><link rel="prefetch" href="/assets/js/129.cae2e6c3.js"><link rel="prefetch" href="/assets/js/13.59f438ee.js"><link rel="prefetch" href="/assets/js/130.386bf4df.js"><link rel="prefetch" href="/assets/js/131.b874fad5.js"><link rel="prefetch" href="/assets/js/132.bcf6f255.js"><link rel="prefetch" href="/assets/js/133.085e084f.js"><link rel="prefetch" href="/assets/js/134.c6765eaf.js"><link rel="prefetch" href="/assets/js/135.a30bdba0.js"><link rel="prefetch" href="/assets/js/136.8662ba72.js"><link rel="prefetch" href="/assets/js/137.99dfae7a.js"><link rel="prefetch" href="/assets/js/138.d6002ed6.js"><link rel="prefetch" href="/assets/js/139.94a0ad48.js"><link rel="prefetch" href="/assets/js/14.aa78a9cb.js"><link rel="prefetch" href="/assets/js/140.36baf76c.js"><link rel="prefetch" href="/assets/js/141.08b885ea.js"><link rel="prefetch" href="/assets/js/142.5c9a067b.js"><link rel="prefetch" href="/assets/js/143.7618c263.js"><link rel="prefetch" href="/assets/js/144.32d05012.js"><link rel="prefetch" href="/assets/js/145.23d20978.js"><link rel="prefetch" href="/assets/js/146.cc85a275.js"><link rel="prefetch" href="/assets/js/147.def435f1.js"><link rel="prefetch" href="/assets/js/148.eae48fc1.js"><link rel="prefetch" href="/assets/js/149.99b81cb1.js"><link rel="prefetch" href="/assets/js/15.6c247b3d.js"><link rel="prefetch" href="/assets/js/150.92a1f630.js"><link rel="prefetch" href="/assets/js/151.a165f09f.js"><link rel="prefetch" href="/assets/js/152.b8d076c5.js"><link rel="prefetch" href="/assets/js/153.1cddaa3f.js"><link rel="prefetch" href="/assets/js/154.6c624fbb.js"><link rel="prefetch" href="/assets/js/155.b05382be.js"><link rel="prefetch" href="/assets/js/156.95493061.js"><link rel="prefetch" href="/assets/js/157.b38c1a4d.js"><link rel="prefetch" href="/assets/js/158.8d5731e6.js"><link rel="prefetch" href="/assets/js/159.03254dc5.js"><link rel="prefetch" href="/assets/js/16.a6c2d532.js"><link rel="prefetch" href="/assets/js/160.c42ca845.js"><link rel="prefetch" href="/assets/js/161.4d871e86.js"><link rel="prefetch" href="/assets/js/162.8a57206f.js"><link rel="prefetch" href="/assets/js/163.ba09db4f.js"><link rel="prefetch" href="/assets/js/164.f41d27e0.js"><link rel="prefetch" href="/assets/js/165.82108bf8.js"><link rel="prefetch" href="/assets/js/166.06cabfc4.js"><link rel="prefetch" href="/assets/js/167.dca7c062.js"><link rel="prefetch" href="/assets/js/168.87290221.js"><link rel="prefetch" href="/assets/js/169.1ae5c929.js"><link rel="prefetch" href="/assets/js/17.b4b7332a.js"><link rel="prefetch" href="/assets/js/170.1a8e2481.js"><link rel="prefetch" href="/assets/js/171.8416d4c9.js"><link rel="prefetch" href="/assets/js/172.51cb4363.js"><link rel="prefetch" href="/assets/js/173.46d98303.js"><link rel="prefetch" href="/assets/js/174.2011bb6e.js"><link rel="prefetch" href="/assets/js/175.c303e2f6.js"><link rel="prefetch" href="/assets/js/176.6cb3982e.js"><link rel="prefetch" href="/assets/js/177.14667589.js"><link rel="prefetch" href="/assets/js/178.1caf3d35.js"><link rel="prefetch" href="/assets/js/179.ae065b43.js"><link rel="prefetch" href="/assets/js/18.6ea24866.js"><link rel="prefetch" href="/assets/js/180.f65b132d.js"><link rel="prefetch" href="/assets/js/181.b6bf0313.js"><link rel="prefetch" href="/assets/js/182.4e944307.js"><link rel="prefetch" href="/assets/js/183.8d321780.js"><link rel="prefetch" href="/assets/js/184.01f97247.js"><link rel="prefetch" href="/assets/js/185.deea1e0c.js"><link rel="prefetch" href="/assets/js/186.6a0e1246.js"><link rel="prefetch" href="/assets/js/187.facd6f8a.js"><link rel="prefetch" href="/assets/js/188.3ed56c82.js"><link rel="prefetch" href="/assets/js/189.6681b39f.js"><link rel="prefetch" href="/assets/js/19.2120e2fc.js"><link rel="prefetch" href="/assets/js/190.d8e21bd0.js"><link rel="prefetch" href="/assets/js/191.b462d0f5.js"><link rel="prefetch" href="/assets/js/192.abdcb3c4.js"><link rel="prefetch" href="/assets/js/193.9d738596.js"><link rel="prefetch" href="/assets/js/194.c14feb3f.js"><link rel="prefetch" href="/assets/js/195.e408656b.js"><link rel="prefetch" href="/assets/js/196.8a7d4ac4.js"><link rel="prefetch" href="/assets/js/197.941a15cd.js"><link rel="prefetch" href="/assets/js/198.f76dedcd.js"><link rel="prefetch" href="/assets/js/199.cc1e4f47.js"><link rel="prefetch" href="/assets/js/20.aac16089.js"><link rel="prefetch" href="/assets/js/200.19067b7a.js"><link rel="prefetch" href="/assets/js/201.fe1e6fc0.js"><link rel="prefetch" href="/assets/js/202.6573718a.js"><link rel="prefetch" href="/assets/js/203.faa3e971.js"><link rel="prefetch" href="/assets/js/21.9490af01.js"><link rel="prefetch" href="/assets/js/22.4d6f493e.js"><link rel="prefetch" href="/assets/js/23.3f1f5159.js"><link rel="prefetch" href="/assets/js/24.8b8ca71d.js"><link rel="prefetch" href="/assets/js/25.20b7f676.js"><link rel="prefetch" href="/assets/js/26.f5458331.js"><link rel="prefetch" href="/assets/js/27.e00d0785.js"><link rel="prefetch" href="/assets/js/29.b6532611.js"><link rel="prefetch" href="/assets/js/3.1716a765.js"><link rel="prefetch" href="/assets/js/30.176bc4c6.js"><link rel="prefetch" href="/assets/js/31.117f5833.js"><link rel="prefetch" href="/assets/js/32.9f960f19.js"><link rel="prefetch" href="/assets/js/33.e1fc54fa.js"><link rel="prefetch" href="/assets/js/34.8ddd15a3.js"><link rel="prefetch" href="/assets/js/35.d598ac70.js"><link rel="prefetch" href="/assets/js/36.24c88b2f.js"><link rel="prefetch" href="/assets/js/37.8a11ca9e.js"><link rel="prefetch" href="/assets/js/38.e8abfc5c.js"><link rel="prefetch" href="/assets/js/39.750bf34a.js"><link rel="prefetch" href="/assets/js/4.d7407e22.js"><link rel="prefetch" href="/assets/js/40.b0807d6d.js"><link rel="prefetch" href="/assets/js/41.549fd4f0.js"><link rel="prefetch" href="/assets/js/42.4e7fe891.js"><link rel="prefetch" href="/assets/js/43.7e1a9b5b.js"><link rel="prefetch" href="/assets/js/44.cf2513ca.js"><link rel="prefetch" href="/assets/js/45.4c6cea7a.js"><link rel="prefetch" href="/assets/js/46.8d6ee3c0.js"><link rel="prefetch" href="/assets/js/47.1757c52d.js"><link rel="prefetch" href="/assets/js/48.3c1d48cd.js"><link rel="prefetch" href="/assets/js/49.646189b6.js"><link rel="prefetch" href="/assets/js/5.0fb010b4.js"><link rel="prefetch" href="/assets/js/50.c34b7013.js"><link rel="prefetch" href="/assets/js/51.68386b75.js"><link rel="prefetch" href="/assets/js/52.82baaf83.js"><link rel="prefetch" href="/assets/js/53.1e46e38a.js"><link rel="prefetch" href="/assets/js/54.0b73420b.js"><link rel="prefetch" href="/assets/js/55.2b0837a5.js"><link rel="prefetch" href="/assets/js/56.89ad4a27.js"><link rel="prefetch" href="/assets/js/57.f6526128.js"><link rel="prefetch" href="/assets/js/58.9737ba80.js"><link rel="prefetch" href="/assets/js/59.fde446bd.js"><link rel="prefetch" href="/assets/js/6.fdf4a7c6.js"><link rel="prefetch" href="/assets/js/60.4209d0e8.js"><link rel="prefetch" href="/assets/js/61.e4d59452.js"><link rel="prefetch" href="/assets/js/62.32b84b3f.js"><link rel="prefetch" href="/assets/js/63.134d21cd.js"><link rel="prefetch" href="/assets/js/64.36a0948e.js"><link rel="prefetch" href="/assets/js/65.1790afd6.js"><link rel="prefetch" href="/assets/js/66.f4b2d9c3.js"><link rel="prefetch" href="/assets/js/67.51970eaf.js"><link rel="prefetch" href="/assets/js/68.01449987.js"><link rel="prefetch" href="/assets/js/69.efc049f6.js"><link rel="prefetch" href="/assets/js/7.d9820b1b.js"><link rel="prefetch" href="/assets/js/70.1638b004.js"><link rel="prefetch" href="/assets/js/71.82e6e817.js"><link rel="prefetch" href="/assets/js/72.e84448c7.js"><link rel="prefetch" href="/assets/js/73.7fdd9182.js"><link rel="prefetch" href="/assets/js/74.1e8a3913.js"><link rel="prefetch" href="/assets/js/75.5e54c05d.js"><link rel="prefetch" href="/assets/js/76.b542b34e.js"><link rel="prefetch" href="/assets/js/77.f23ac509.js"><link rel="prefetch" href="/assets/js/78.a8205009.js"><link rel="prefetch" href="/assets/js/79.2790fe7b.js"><link rel="prefetch" href="/assets/js/8.94221484.js"><link rel="prefetch" href="/assets/js/80.86f9431e.js"><link rel="prefetch" href="/assets/js/81.a44b619a.js"><link rel="prefetch" href="/assets/js/82.44b07629.js"><link rel="prefetch" href="/assets/js/83.ea9a72b8.js"><link rel="prefetch" href="/assets/js/84.9b7e3a6e.js"><link rel="prefetch" href="/assets/js/85.f7705353.js"><link rel="prefetch" href="/assets/js/86.9cd3e28a.js"><link rel="prefetch" href="/assets/js/87.1f41e79d.js"><link rel="prefetch" href="/assets/js/88.beb49e83.js"><link rel="prefetch" href="/assets/js/89.b45271ab.js"><link rel="prefetch" href="/assets/js/9.1f564f7c.js"><link rel="prefetch" href="/assets/js/90.f498a210.js"><link rel="prefetch" href="/assets/js/91.9560dc56.js"><link rel="prefetch" href="/assets/js/92.20aa3420.js"><link rel="prefetch" href="/assets/js/93.bdc9fb1b.js"><link rel="prefetch" href="/assets/js/94.28d6b294.js"><link rel="prefetch" href="/assets/js/95.83c5dd12.js"><link rel="prefetch" href="/assets/js/96.6dc26c95.js"><link rel="prefetch" href="/assets/js/97.f476bd8e.js"><link rel="prefetch" href="/assets/js/98.b6e31352.js"><link rel="prefetch" href="/assets/js/99.7000f232.js">
    <link rel="stylesheet" href="/assets/css/0.styles.84741abc.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Teach English</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/about/" class="nav-link">
  About
</a></div><div class="nav-item"><a href="/categories/" class="nav-link">
  Categories
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/about/" class="nav-link">
  About
</a></div><div class="nav-item"><a href="/categories/" class="nav-link">
  Categories
</a></div> <!----></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="ソースコードの場所について"><a href="#ソースコードの場所について" class="header-anchor">#</a> ソースコードの場所について</h2> <div class="language- extra-class"><pre class="language-text"><code>lib/csv/shopify/
  ∟ base_import.rb              (共通系の処理)
  ∟ customer_import.rb          (Shopifyの顧客CSVを新Meethにimport)
  ∟ order_import.rb    　　　　　 (Shopifyの注文CSVを新Meethにimport)
  ∟ subscription_import.rb    　(Shopifyの定期購入CSVを新Meethにimport)
  ∟ order_detail_bulk_update.rb (OrderDetailの一括更新用のツール) ※ ツールなのでディレクトリ移動予定
  ∟ subscription_bulk_update.rb (Subscriptionの一括更新用のツール) ※ ツールなのでディレクトリ移動予定
</code></pre></div><ul><li>メインのcutomer_import、order_import、subscription_importは時間かかるが、shopifyのデータが予期しないものがくることがあるので、どこでエラーかわかるように1件づつ処理する</li> <li>更新系は、一度データ入れば問題ないのでBulk利用でもOK(Rails6のupsert_allはバリデーション使えないので、activerecord-importを利用している)</li> <li>Bulk使う場合、一部のenumが命名規則に違反しているので使えないので注意が必要</li></ul> <h2 id="customer-csvのインポートについて"><a href="#customer-csvのインポートについて" class="header-anchor">#</a> Customer CSVのインポートについて</h2> <p>Command:</p> <div class="language- extra-class"><pre class="language-text"><code>bundle exec rake csv_import:shopify_customers[{CSVファイルパス}]
</code></pre></div><p>内容:
指定された顧客情報CSVファイルを読み込んで1件づつDBに保存する(対象： Customer, CustomerAddress)
※ 1件づつにしているのはShopifyのデータがイレギュラーのが多いので、どこの行でエラーになったか把握するため</p> <h3 id="登録する項目"><a href="#登録する項目" class="header-anchor">#</a> 登録する項目</h3> <h4 id="customerテーブル"><a href="#customerテーブル" class="header-anchor">#</a> Customerテーブル</h4> <table><thead><tr><th style="text-align:left;">カラム名</th> <th style="text-align:left;">Value</th> <th style="text-align:left;">備考</th></tr></thead> <tbody><tr><td style="text-align:left;">password</td> <td style="text-align:left;">ランダムで作成したPW</td> <td style="text-align:left;">テーブルが必須なので仮で入れる ※shopifyからの移行データはPWなしでもOK</td></tr> <tr><td style="text-align:left;">email</td> <td style="text-align:left;">CSVのemail項目</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;">family_name</td> <td style="text-align:left;">CSVのlast_name項目</td> <td style="text-align:left;">CSVに存在しない場合は、空文字</td></tr> <tr><td style="text-align:left;">first_name</td> <td style="text-align:left;">CSVのfirst_name項目</td> <td style="text-align:left;">CSVに存在しない場合は、空文字</td></tr> <tr><td style="text-align:left;">birthday</td> <td style="text-align:left;">1999/01/01</td> <td style="text-align:left;">固定</td></tr> <tr><td style="text-align:left;">gender</td> <td style="text-align:left;">no_answer</td> <td style="text-align:left;">固定</td></tr> <tr><td style="text-align:left;">status</td> <td style="text-align:left;">active</td> <td style="text-align:left;">固定</td></tr> <tr><td style="text-align:left;">from_shopify</td> <td style="text-align:left;">true</td> <td style="text-align:left;">固定</td></tr> <tr><td style="text-align:left;">dm_agreed</td> <td style="text-align:left;">CSVのaccepts_marketing項目</td> <td style="text-align:left;">Yesの場合、true</td></tr></tbody></table> <h4 id="customeraddressテーブル"><a href="#customeraddressテーブル" class="header-anchor">#</a> CustomerAddressテーブル</h4> <table><thead><tr><th style="text-align:left;">カラム名</th> <th style="text-align:left;">Value</th> <th style="text-align:left;">備考</th></tr></thead> <tbody><tr><td style="text-align:left;">customer_id</td> <td style="text-align:left;">CustomerテーブルID</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;">phone</td> <td style="text-align:left;">CSVのphone項目</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;">family_name</td> <td style="text-align:left;">CSVのlast_name項目</td> <td style="text-align:left;">CSVに存在しない場合は、空文字</td></tr> <tr><td style="text-align:left;">first_name</td> <td style="text-align:left;">CSVのfirst_name項目</td> <td style="text-align:left;">CSVに存在しない場合は、空文字</td></tr> <tr><td style="text-align:left;">company_name</td> <td style="text-align:left;">CSVのcompany項目</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;">country</td> <td style="text-align:left;">CSVのcountry_code項目</td> <td style="text-align:left;">country_codeがない場合、CSVのcountry項目が入る</td></tr> <tr><td style="text-align:left;">zip_code</td> <td style="text-align:left;">CSVのzip項目</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;">prefecture</td> <td style="text-align:left;">CSVのprovince_code項目</td> <td style="text-align:left;">province_codeがない場合、CSVのprovince項目が入る ※いいツールでも無いかぎりiso3166-2の世界対応はかなり工数かかるので、原則日本のみ</td></tr> <tr><td style="text-align:left;">address1</td> <td style="text-align:left;">CSVのcity項目</td> <td style="text-align:left;">CSVに存在しない場合は、空文字</td></tr> <tr><td style="text-align:left;">address2</td> <td style="text-align:left;">CSVのaddress1項目</td> <td style="text-align:left;">CSVに存在しない場合は、空文字</td></tr> <tr><td style="text-align:left;">address3</td> <td style="text-align:left;">CSVのaddress２項目</td> <td style="text-align:left;">CSVに存在しない場合は、空文字</td></tr> <tr><td style="text-align:left;">is_default</td> <td style="text-align:left;">1</td> <td style="text-align:left;">固定</td></tr></tbody></table> <h2 id="subscription-csvのインポートについて"><a href="#subscription-csvのインポートについて" class="header-anchor">#</a> Subscription CSVのインポートについて</h2> <p>Command:</p> <div class="language- extra-class"><pre class="language-text"><code>bundle exec rake csv_import:shopify_subscriptions[{CSVファイルパス}]
</code></pre></div><p>内容:
指定された定期購入のCSVファイルを読み込んで1件づつDBに保存する(対象： Subscription, SubscriptionDetail)</p> <p>顧客情報との紐付け:
CSVのcustomer_emailと 新Meethのcustomerテーブルのemailを紐付けて処理する</p> <h3 id="登録する項目-2"><a href="#登録する項目-2" class="header-anchor">#</a> 登録する項目</h3> <h4 id="subscriptionテーブル"><a href="#subscriptionテーブル" class="header-anchor">#</a> Subscriptionテーブル</h4> <table><thead><tr><th style="text-align:left;">カラム名</th> <th style="text-align:left;">Value</th> <th style="text-align:left;">備考</th></tr></thead> <tbody><tr><td style="text-align:left;">customer_id</td> <td style="text-align:left;">CustomerテーブルのID</td> <td style="text-align:left;">CSVのcustomer_emailと一致した、Customer情報</td></tr> <tr><td style="text-align:left;">status</td> <td style="text-align:left;">CSVのactive項目</td> <td style="text-align:left;">Yesの場合、<code>active</code> それ以外、<code>reversal_ng</code></td></tr> <tr><td style="text-align:left;">processing_status</td> <td style="text-align:left;">CSVのis_paused項目</td> <td style="text-align:left;">1の場合、<code>pending</code> それ以外、<code>processing</code> ※ 配送完了しているかここではわからないため</td></tr> <tr><td style="text-align:left;">delivery_plan</td> <td style="text-align:left;">CSVのlast_order_date項目の日にちから計算</td> <td style="text-align:left;">正確ではないので、はorder import時に<strong>配送完了日を見て再設定</strong>する</td></tr> <tr><td style="text-align:left;">payment_method</td> <td style="text-align:left;">credit_card(固定)</td> <td style="text-align:left;">BoldはStripeを推奨しているそうなので、credit_card固定にしています。https://commerce-media.info/blogs/ec/shopify-bold-01</td></tr> <tr><td style="text-align:left;">customer_address_id</td> <td style="text-align:left;">CustomerAddressテーブルのID</td> <td style="text-align:left;">住所情報が複数ある場合は、最初のID</td></tr> <tr><td style="text-align:left;">shopify_subscription_id</td> <td style="text-align:left;">CSVのsubscription_id項目</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;">shopify_last_order_date</td> <td style="text-align:left;">CSVのlast_order_date項目</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;">shopify_subscription_date</td> <td style="text-align:left;">CSVのsubscription_date項目</td> <td style="text-align:left;"></td></tr></tbody></table> <h4 id="subscriptiondetailテーブル"><a href="#subscriptiondetailテーブル" class="header-anchor">#</a> SubscriptionDetailテーブル</h4> <table><thead><tr><th style="text-align:left;">カラム名</th> <th style="text-align:left;">Value</th> <th style="text-align:left;">備考</th></tr></thead> <tbody><tr><td style="text-align:left;">subscription_id</td> <td style="text-align:left;">SubscriptionテーブルのID</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;">product_detail_id</td> <td style="text-align:left;">CSVのproducts項目を元にマッピングしたProductDetailテーブルID</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;">product_price_id</td> <td style="text-align:left;">CSVのproducts項目を元にマッピングしたProductPriceテーブルID</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;">status</td> <td style="text-align:left;">st_dummy</td> <td style="text-align:left;">st_dummyこの意味は不明。値はこれしかないので</td></tr> <tr><td style="text-align:left;">quantity</td> <td style="text-align:left;">credit_card(固定)</td> <td style="text-align:left;">BoldはStripeを推奨しているそうなので、credit_card固定にしています。https://commerce-media.info/blogs/ec/shopify-bold-01</td></tr></tbody></table> <ul><li>商品情報の取得について
<ul><li><strong>Shopifyの商品ID・名前と新Meethの商品IDと名前は一致しない</strong></li> <li><strong>そのため、Shopify商品名 -&gt; プログラム内でその商品名とマッピングさせた新Meethの商品IDを返して処理させる</strong></li></ul></li></ul> <h2 id="order-csvのインポートについて"><a href="#order-csvのインポートについて" class="header-anchor">#</a> Order CSVのインポートについて</h2> <p>Command:</p> <div class="language- extra-class"><pre class="language-text"><code>bundle exec rake csv_import:shopify_orders[{CSVフォルダパス}]
</code></pre></div><p>内容:
指定された注文のCSVファイルを読み込んで1件づつDBに保存する(対象： Order, Subscription, Customer, CustomerAddress, OrderAddress, BillingAddress, OrderDetail, Payment)</p> <p>顧客情報との紐付け:
CSVのemailと 新Meethのcustomerテーブルのemailを紐付けて処理する</p> <h3 id="登録する項目-3"><a href="#登録する項目-3" class="header-anchor">#</a> 登録する項目</h3> <h4 id="customer-customeraddressテーブル"><a href="#customer-customeraddressテーブル" class="header-anchor">#</a> Customer, CustomerAddressテーブル</h4> <div class="language- extra-class"><pre class="language-text"><code>[6] pry(main)&gt; customer = Customer.new(
[6] pry(main)*   password: &quot;password&quot;,              
[6] pry(main)*   email: &quot;test111111@test.com&quot;,              
[6] pry(main)*   family_name: &quot;&quot;,              
[6] pry(main)*   first_name: &quot;&quot;,              
[6] pry(main)*   birthday: &quot;1999/01/01&quot;,              
[6] pry(main)*   gender: :no_answer,              
[6] pry(main)*   status: :active,              
[6] pry(main)*   activated: false,              
[6] pry(main)*   from_shopify: true,              
[6] pry(main)*   dm_agreed: false              
[6] pry(main)* )              
   (16.9ms)  SET NAMES utf8mb4 COLLATE utf8mb4_bin,  @@SESSION.sql_mode = CONCAT(CONCAT(@@sql_mode, ',STRICT_ALL_TABLES'), ',NO_AUTO_VALUE_ON_ZERO'),  @@SESSION.sql_auto_is_null = 0, @@SESSION.wait_timeout = 2147483
/usr/local/bundle/gems/activemodel-6.0.2.1/lib/active_model/type/integer.rb:13: warning: Using the last argument as keyword parameters is deprecated; maybe ** should be added to the call
/usr/local/bundle/gems/activemodel-6.0.2.1/lib/active_model/type/value.rb:8: warning: The called method `initialize' is defined here
=&gt; #&lt;Customer:0x000055d368058e80

 id: nil,
 email: &quot;test111111@test.com&quot;,
 password_digest: &quot;$2a$12$q29H0aeSEPS.Z.lJStm7ve4p5KKqWPI9iR8asWi5k/nzTT7Fh9iDa&quot;,
 remember_token: nil,
 family_name: &quot;&quot;,
 first_name: &quot;&quot;,
 birthday: Fri, 01 Jan 1999,
 gender: &quot;no_answer&quot;,
 dm_agreed: false,
 status: &quot;active&quot;,
 password_reset_digest: nil,
 password_reset_issued_at: nil,
 created_at: nil,
 updated_at: nil,
 activation_digest: nil,
 activated: false,
 activation_issued_at: nil,
 mail_address_update_digest: nil,
 mail_address_update_issued_at: nil,
 temporary_email_address: nil,
 card_registered: false,
 from_shopify: true,
 pw_update_completed: nil,
 delivery_plan_reset_completed: nil,
 movement_digest: nil,
 movement_issued_at: nil&gt;
[7] pry(main)&gt; customer&amp;.save!(validate: false)            
   (5.7ms)  BEGIN
  Customer Create (137.2ms)  INSERT INTO `customers` (`id`, `email`, `password_digest`, `family_name`, `first_name`, `birthday`, `gender`, `status`, `created_at`, `updated_at`, `activation_digest`, `from_shopify`) VALUES (1342444182697938946, 'test111111@test.com', '$2a$12$q29H0aeSEPS.Z.lJStm7ve4p5KKqWPI9iR8asWi5k/nzTT7Fh9iDa', '', '', '1999-01-01', 9, 1, '2020-12-25 21:16:49.219181', '2020-12-25 21:16:49.219181', '4c4e3656c64582cfec5860346a2019d9e8dc9896a33481546854bae74f1aa4e4', TRUE)
  CustomerRegulation Load (27.1ms)  SELECT `customer_regulations`.* FROM `customer_regulations` WHERE `customer_regulations`.`customer_id` = 1342444182697938946
   (11.5ms)  COMMIT
=&gt; true
[8] pry(main)&gt; 
</code></pre></div><p>・メールアドレスが既存のCustomerテーブルに存在しない場合、メールアドレスとパスワード以外は固定で入る
=&gt; この理由は本番でimportを実行した際、入らなかったデータが存在し、そのデータをがShopifyで会員にならずに注文したユーザーのため。</p> <h4 id="orderテーブル"><a href="#orderテーブル" class="header-anchor">#</a> Orderテーブル</h4> <table><thead><tr><th style="text-align:left;">カラム名</th> <th style="text-align:left;">Value</th> <th style="text-align:left;">備考</th></tr></thead> <tbody><tr><td style="text-align:left;">customer_id</td> <td style="text-align:left;">CustomerテーブルのID</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;">subscription_id</td> <td style="text-align:left;">SubscriptionテーブルのID</td> <td style="text-align:left;">CSVのTags項目に「recurring_order」が存在する場合且つ、Subscriptionテーブルに存在する場合</td></tr> <tr><td style="text-align:left;">total_amount</td> <td style="text-align:left;">CSVのsubtotal項目</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;">fee</td> <td style="text-align:left;">0</td> <td style="text-align:left;">固定</td></tr> <tr><td style="text-align:left;">delivery_method</td> <td style="text-align:left;">ems or yamato</td> <td style="text-align:left;">CSVのshipping_method項目にInternationalが存在する場合は、ems それ以外はyamato</td></tr> <tr><td style="text-align:left;">desired_delivery_date</td> <td style="text-align:left;">nil</td> <td style="text-align:left;">固定</td></tr> <tr><td style="text-align:left;">desired_delivery_time</td> <td style="text-align:left;">nil</td> <td style="text-align:left;">固定</td></tr> <tr><td style="text-align:left;">order_category</td> <td style="text-align:left;">normal</td> <td style="text-align:left;">固定</td></tr> <tr><td style="text-align:left;">status</td> <td style="text-align:left;">CSVのfulfillment_status項目で判断</td> <td style="text-align:left;">新Meethとstatusが異なるので、finished(fulfilled), processing(partial), canceled(restocked), returned(fulfilled 且つ CSVのfinancial_status項目がrefunded), pending(それ以外) ※かっこ内はCSVの値</td></tr> <tr><td style="text-align:left;">shipping_status</td> <td style="text-align:left;">CSVのfulfillment_status項目で判断</td> <td style="text-align:left;">こちらは新Meeth似ているので、finished(fulfilled), preparing(partial), canceled(restocked), returned(fulfilled 且つ CSVのfinancial_status項目がrefunded), undispatched(それ以外) ※かっこ内はCSVの値</td></tr> <tr><td style="text-align:left;">shipping_at</td> <td style="text-align:left;">CSVのfulfilled_at項目</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;">email_status</td> <td style="text-align:left;">product_shipped</td> <td style="text-align:left;">固定</td></tr> <tr><td style="text-align:left;">shopify_order_id</td> <td style="text-align:left;">CSVのid項目</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;">shopify_fulfilled_at</td> <td style="text-align:left;">CSVのfulfilled_at項目</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;">created_at</td> <td style="text-align:left;">CSVのcreated_at項目</td> <td style="text-align:left;">ここは、ユーザーの注文詳細画面でここの値を入れているので、CSVの値を入れる</td></tr></tbody></table> <ul><li>subscription_idについて</li> <li>定期購入データは、過去のデータも存在(例 2020-01に開始 -&gt; 2020-04に終了、2020-08に開始の場合、2レコード)するため、 subscriptionテーブルの shopify_subscription_date以降のデータと紐付ける</li></ul> <h4 id="orderdetailテーブル"><a href="#orderdetailテーブル" class="header-anchor">#</a> OrderDetailテーブル</h4> <table><thead><tr><th style="text-align:left;">カラム名</th> <th style="text-align:left;">Value</th> <th style="text-align:left;">備考</th></tr></thead> <tbody><tr><td style="text-align:left;">order_id</td> <td style="text-align:left;">OrderテーブルのID</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;">product_detail_id</td> <td style="text-align:left;">CSVのlineitem_name項目を元にマッピングしたProductDetailテーブルID</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;">product_price_id</td> <td style="text-align:left;">CSVのlineitem_name項目を元にマッピングしたProductPriceテーブルID</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;">billing_amount</td> <td style="text-align:left;">CSVのlineitem_price項目 x CSVのlineitem_quantity項目</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;">status</td> <td style="text-align:left;">CSVのlineitem_fulfillment_status項目</td> <td style="text-align:left;">finished(fulfilled)、pending（それ以外） リファレンス見ると <code>fulfilled</code> か空白でくるみたい  https://help.shopify.com/ja/manual/migrating-to-shopify/transporter-app/csv-orders</td></tr> <tr><td style="text-align:left;">tax_rate</td> <td style="text-align:left;">CSVのtax1_name項目</td> <td style="text-align:left;">Tax XX%と来るので、その値を入れる</td></tr> <tr><td style="text-align:left;">quantity</td> <td style="text-align:left;">CSVのlineitem_quantity項目</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;">order_address_id</td> <td style="text-align:left;">OrderAddressテーブルのID</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;">billing_address_id</td> <td style="text-align:left;">BillingAddressテーブルのID</td> <td style="text-align:left;"></td></tr></tbody></table> <h4 id="orderaddressテーブル"><a href="#orderaddressテーブル" class="header-anchor">#</a> OrderAddressテーブル</h4> <table><thead><tr><th style="text-align:left;">カラム名</th> <th style="text-align:left;">Value</th> <th style="text-align:left;">備考</th></tr></thead> <tbody><tr><td style="text-align:left;">address1</td> <td style="text-align:left;">CSVのshipping_city項目</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;">address2</td> <td style="text-align:left;">CSVのshipping_address1項目</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;">address3</td> <td style="text-align:left;">CSVのshipping_address2項目</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;">country</td> <td style="text-align:left;">CSVのshipping_country項目を元に算出した国</td> <td style="text-align:left;">※ない場合は国コードそのまま入る</td></tr> <tr><td style="text-align:left;">shipping_cost</td> <td style="text-align:left;">CSVのshipping項目</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;">family_name</td> <td style="text-align:left;">CSVのshipping_name項目</td> <td style="text-align:left;">姓名が一緒の項目に入っているので、半角スペースで分けた前半</td></tr> <tr><td style="text-align:left;">first_name</td> <td style="text-align:left;">CSVのshipping_name項目</td> <td style="text-align:left;">姓名が一緒の項目に入っているので、半角スペースで分けた後半</td></tr> <tr><td style="text-align:left;">phone</td> <td style="text-align:left;">CSVのshipping_phone項目</td> <td style="text-align:left;">国際番号、記号など入ってくるため、バリデーションエラーにならないように加工して入れる</td></tr> <tr><td style="text-align:left;">prefecture</td> <td style="text-align:left;">CSVのshipping_province項目</td> <td style="text-align:left;">iso3166-2のコードでくるので、全て対応は時間的に難しいので日本とアメリカのみ。それ以外はCSVのshipping_province項目が入る ※ ここはあった場合、ユーザーに直してもらうか、Update文で対応など簡単な方で対応</td></tr> <tr><td style="text-align:left;">zip_code</td> <td style="text-align:left;">CSVのshipping_zip項目</td> <td style="text-align:left;">ない場合は、0000000</td></tr></tbody></table> <h4 id="billingaddressテーブル"><a href="#billingaddressテーブル" class="header-anchor">#</a> BillingAddressテーブル</h4> <table><thead><tr><th style="text-align:left;">カラム名</th> <th style="text-align:left;">Value</th> <th style="text-align:left;">備考</th></tr></thead> <tbody><tr><td style="text-align:left;">address1</td> <td style="text-align:left;">CSVのbilling_city項目</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;">address2</td> <td style="text-align:left;">CSVのbilling_address1項目</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;">address3</td> <td style="text-align:left;">CSVのbilling_address2項目</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;">country</td> <td style="text-align:left;">CSVのbilling_country項目を元に算出した国</td> <td style="text-align:left;">※ない場合は国コードそのまま入る</td></tr> <tr><td style="text-align:left;">family_name</td> <td style="text-align:left;">CSVのbilling_name項目</td> <td style="text-align:left;">姓名が一緒の項目に入っているので、半角スペースで分けた前半</td></tr> <tr><td style="text-align:left;">first_name</td> <td style="text-align:left;">CSVのbilling_name項目</td> <td style="text-align:left;">姓名が一緒の項目に入っているので、半角スペースで分けた後半</td></tr> <tr><td style="text-align:left;">phone</td> <td style="text-align:left;">CSVのbilling_phone項目</td> <td style="text-align:left;">国際番号、記号など入ってくるため、バリデーションエラーにならないように加工して入れる</td></tr> <tr><td style="text-align:left;">prefecture</td> <td style="text-align:left;">CSVのbilling_province項目</td> <td style="text-align:left;">iso3166-2のコードでくるので、全て対応は時間的に難しいので日本とアメリカのみ。それ以外はCSVのbilling_province項目が入る ※ ここはあった場合、ユーザーに直してもらうか、Update文で対応など簡単な方で対応</td></tr> <tr><td style="text-align:left;">zip_code</td> <td style="text-align:left;">CSVのbilling_zip項目</td> <td style="text-align:left;">ない場合は、0000000</td></tr></tbody></table> <h4 id="paymentテーブル"><a href="#paymentテーブル" class="header-anchor">#</a> Paymentテーブル</h4> <table><thead><tr><th style="text-align:left;">カラム名</th> <th style="text-align:left;">Value</th> <th style="text-align:left;">備考</th></tr></thead> <tbody><tr><td style="text-align:left;">customer_id</td> <td style="text-align:left;">OrderテーブルのCustomerID</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;">order_id</td> <td style="text-align:left;">OrderテーブルのID</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;">status</td> <td style="text-align:left;">CSVのfinancial_status項目</td> <td style="text-align:left;">shopifyのステータスとかなり異なる。ひとまず記載する通り入れる。auth(pending, authorized, partially_paid),capture(paid),returned(refunded),canceled(voided),auth(それ以外) ※かっこ内はCSVの値</td></tr> <tr><td style="text-align:left;">payment_method</td> <td style="text-align:left;">CSVのpayment_method項目</td> <td style="text-align:left;">paypal(PayPal), cod(Cash on), bank_transfer(Bank), credit_card(それ以外)  ※かっこ内はCSVの値</td></tr></tbody></table> <h2 id="追加のカラムについて"><a href="#追加のカラムについて" class="header-anchor">#</a> 追加のカラムについて</h2> <p>shopifyのデータかどうか確認するため以下のカラムを追加している</p> <h3 id="subscriptions"><a href="#subscriptions" class="header-anchor">#</a> Subscriptions</h3> <div class="language- extra-class"><pre class="language-text"><code>- shopify_subscription_id: Shopify側の定期購入ID
- shopify_last_order_date: Shopify側の定期購入の最後に注文した日付
- shopify_subscription_date: Shopify側の定期購入の開始した日付
</code></pre></div><h3 id="orders"><a href="#orders" class="header-anchor">#</a> Orders</h3> <div class="language- extra-class"><pre class="language-text"><code>- shopify_order_id: Shopify側の注文ID
- shopify_fulfilled_at: Shopify側の配送完了日
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.4d20ba07.js" defer></script><script src="/assets/js/2.7e8b5cf7.js" defer></script><script src="/assets/js/28.287295ad.js" defer></script>
  </body>
</html>
