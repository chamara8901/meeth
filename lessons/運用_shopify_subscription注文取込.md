## 概要
shopifyで日々作成される定期注文データを新meethに取り込む

## 前段・後続作業
- 前段作業：shopify定期注文データ出力
- 後続作業：運用_出荷CSV出力

## 実行タイミング

- 曜日：月曜日〜土曜日
- 時間：0:00〜10:00 の間

## 実行対象
- 実行日前日に作成されたshopify注文データ

## 作業フロー

1. shopifyにログイン
1. 実行日前日の注文データを日付指定で抽出
1. 差分取込バッチで抽出した注文を取込。コマンド：`$ bundle exec rake csv_import:shopify_diff_orders[{CSVファイル格納ディレクトリパス}]`
1. 新meethDBにログイン
1. DB操作で当該データの新meeth注文IDを抽出する
1. 抽出条件：
   - [orders.shopify_order_id is not null](https://github.com/grrowjp/Meeth/wiki/%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E5%AE%9A%E7%BE%A9_orders#orderst) //shopifyで生成された注文の場合はshopifyの注文番号（長い方）が入っている
   - [orders.status = 2](https://github.com/grrowjp/Meeth/wiki/%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E5%AE%9A%E7%BE%A9_orders#orderst) //注文ステータスが保留
   - [payments.status = 2](https://docs.google.com/spreadsheets/d/1lUmvenkr5ejjbUE94PmhqNayrkiqSJutftjH3E-JnaU/edit#gid=0&range=133:133) //支払いステータスが実売上
1. 抽出した新meeth注文IDを元に注文ステータスを更新
   - [orders.status = 1](https://github.com/grrowjp/Meeth/wiki/%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E5%AE%9A%E7%BE%A9_orders#orderst) //注文ステータスを処理中に変更
   - [payments.status = 1](https://github.com/grrowjp/Meeth/wiki/%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E5%AE%9A%E7%BE%A9_orders#orderst) //支払いステータスを仮売上に変更

## 新meeth注文抽出クエリ

```sql
select
	*
from
	orders o ,
	payments p
where
	o.id = p.order_id
	and o.shopify_order_id is not null
	and o.status = 2
	and p.status = 2
	and substr(o.created_at, 1, 10) = 'YYYY-MM-DD';# YYYY-MM-DDはshopify上で指定した日付
```

## 新meeth注文ステータス変更クエリ（注文ステータスを処理中にする）
```sql
update
	orders
set
	status = 1
where
	id in (xxxxxx) # xxxxxxは変更したい注文ID
```

## 新meeth支払いステータス変更クエリ（支払いステータスを仮売上にする）
```sql
update
	payments
set
	status = 1
where
	order_id in (xxxxxx) # xxxxxxは変更したい注文ID
```

## 20210206実行結果
```sql
-- 1.orderテーブル、paymentsテーブルのステータス（実売上、保留中）を抽出するSQL
select * from orders o ,payments p where o.id=p.order_id and o.shopify_order_id is not null and o.status =2 and p.status=2 and substr(o.created_at,1,10) = '2021-02-06';

-- 2.orderテーブルのステータスを保留;2 > 処理中;1 に変更
update orders set status = 1 where id in (1002783);

-- 3.変更後のorderテーブルを確認（保留;2 > 処理中;1 に変更したことを確認）
SELECT * FROM orders where id = 1002783;

-- 4.paymentsテーブルのステータスを実売上;2 > 仮売上;1 に変更
update payments set status = 1 where order_id in (1002783);

-- 5.paymentsテーブルのステータスを（実売上;2 > 仮売上;1 に変更）
SELECT * FROM payments where order_id = 1002783;	

-- 6.ordesテーブルのステータスを保留 > 処理中 に一括変更する
update orders set status = 1 where id in (1002783,1002784,1002785,1002786,1002787,1002788,1002789,1002790,1002791,1002792,1002793,1002794,1002795,1002796,1002797,1002798,1002799,1002800,1002801,1002802,1002803,1002804,1002805,1002806,1002807,1002808,1002809,1002810,1002811,1002812,1002813,1002814,1002815,1002816,1002817,1002818,1002819,1002820,1002821,1002822,1002823,1002824,1002825,1002826,1002827,1002828,1002829,1002830,1002831,1002832,1002833,1002834,1002835,1002836,1002837,1002838,1002839,1002840,1002841,1002842,1002843,1002844,1002845,1002846,1002847,1002848,1002849,1002850,1002851,1002852,1002853,1002854,1002855,1002856,1002857,1002858,1002859,1002860,1002861,1002862,1002863,1002864,1002865,1002866,1002867,1002868,1002869,1002870,1002871,1002872,1002873,1002874,1002875,1002876,1002877,1002878,1002879,1002880,1002881,1002882,1002883,1002884,1002885,1002886,1002887,1002888,1002889,1002890,1002891,1002892,1002893,1002894,1002895,1002896,1002897,1002898,1002899,1002900,1002901,1002902,1002903,1002904,1002905,1002906,1002907,1002908,1002909,1002910,1002911,1002912,1002913,1002914,1002915,1002916,1002917,1002918);

-- 7.ordersテーブルの最終確認用のクエリ
SELECT * FROM orders where id in (1002783,1002784,1002785,1002786,1002787,1002788,1002789,1002790,1002791,1002792,1002793,1002794,1002795,1002796,1002797,1002798,1002799,1002800,1002801,1002802,1002803,1002804,1002805,1002806,1002807,1002808,1002809,1002810,1002811,1002812,1002813,1002814,1002815,1002816,1002817,1002818,1002819,1002820,1002821,1002822,1002823,1002824,1002825,1002826,1002827,1002828,1002829,1002830,1002831,1002832,1002833,1002834,1002835,1002836,1002837,1002838,1002839,1002840,1002841,1002842,1002843,1002844,1002845,1002846,1002847,1002848,1002849,1002850,1002851,1002852,1002853,1002854,1002855,1002856,1002857,1002858,1002859,1002860,1002861,1002862,1002863,1002864,1002865,1002866,1002867,1002868,1002869,1002870,1002871,1002872,1002873,1002874,1002875,1002876,1002877,1002878,1002879,1002880,1002881,1002882,1002883,1002884,1002885,1002886,1002887,1002888,1002889,1002890,1002891,1002892,1002893,1002894,1002895,1002896,1002897,1002898,1002899,1002900,1002901,1002902,1002903,1002904,1002905,1002906,1002907,1002908,1002909,1002910,1002911,1002912,1002913,1002914,1002915,1002916,1002917,1002918);

-- 8.paymentsテーブルのステータスを実売上 > 仮売上 に一括変更する
update payments	set status = 1 where order_id in (1002783,1002784,1002785,1002786,1002787,1002788,1002789,1002790,1002791,1002792,1002793,1002794,1002795,1002796,1002797,1002798,1002799,1002800,1002801,1002802,1002803,1002804,1002805,1002806,1002807,1002808,1002809,1002810,1002811,1002812,1002813,1002814,1002815,1002816,1002817,1002818,1002819,1002820,1002821,1002822,1002823,1002824,1002825,1002826,1002827,1002828,1002829,1002830,1002831,1002832,1002833,1002834,1002835,1002836,1002837,1002838,1002839,1002840,1002841,1002842,1002843,1002844,1002845,1002846,1002847,1002848,1002849,1002850,1002851,1002852,1002853,1002854,1002855,1002856,1002857,1002858,1002859,1002860,1002861,1002862,1002863,1002864,1002865,1002866,1002867,1002868,1002869,1002870,1002871,1002872,1002873,1002874,1002875,1002876,1002877,1002878,1002879,1002880,1002881,1002882,1002883,1002884,1002885,1002886,1002887,1002888,1002889,1002890,1002891,1002892,1002893,1002894,1002895,1002896,1002897,1002898,1002899,1002900,1002901,1002902,1002903,1002904,1002905,1002906,1002907,1002908,1002909,1002910,1002911,1002912,1002913,1002914,1002915,1002916,1002917,1002918);

-- 9.paymentsテーブルの最終確認用のクエリ
SELECT * FROM payments where order_id in (1002783,1002784,1002785,1002786,1002787,1002788,1002789,1002790,1002791,1002792,1002793,1002794,1002795,1002796,1002797,1002798,1002799,1002800,1002801,1002802,1002803,1002804,1002805,1002806,1002807,1002808,1002809,1002810,1002811,1002812,1002813,1002814,1002815,1002816,1002817,1002818,1002819,1002820,1002821,1002822,1002823,1002824,1002825,1002826,1002827,1002828,1002829,1002830,1002831,1002832,1002833,1002834,1002835,1002836,1002837,1002838,1002839,1002840,1002841,1002842,1002843,1002844,1002845,1002846,1002847,1002848,1002849,1002850,1002851,1002852,1002853,1002854,1002855,1002856,1002857,1002858,1002859,1002860,1002861,1002862,1002863,1002864,1002865,1002866,1002867,1002868,1002869,1002870,1002871,1002872,1002873,1002874,1002875,1002876,1002877,1002878,1002879,1002880,1002881,1002882,1002883,1002884,1002885,1002886,1002887,1002888,1002889,1002890,1002891,1002892,1002893,1002894,1002895,1002896,1002897,1002898,1002899,1002900,1002901,1002902,1002903,1002904,1002905,1002906,1002907,1002908,1002909,1002910,1002911,1002912,1002913,1002914,1002915,1002916,1002917,1002918);

```
