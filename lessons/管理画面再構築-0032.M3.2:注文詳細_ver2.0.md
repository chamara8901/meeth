# 1. [管理画面再構築](%E7%AE%A1%E7%90%86%E7%94%BB%E9%9D%A2%E5%86%8D%E6%A7%8B%E7%AF%89-%E7%94%BB%E9%9D%A2%E4%B8%80%E8%A6%A7%28ver2.0%29)-M3.2:注文詳細 機能設計書

- [1. 管理画面再構築-M3.2:注文詳細 機能設計書](#1-管理画面再構築-m32注文詳細-機能設計書)
  - [1.1. 処理概要](#11-処理概要)
    - [1.1.1. 機能名](#111-機能名)
    - [1.1.2. 機能概要](#112-機能概要)
    - [1.1.3. 前提条件](#113-前提条件)
    - [1.1.4. 処理概要](#114-処理概要)
    - [1.1.5. パラメータ一覧](#115-パラメータ一覧)
    - [1.1.6. テーブル一覧](#116-テーブル一覧)
    - [1.1.7. ファイル一覧](#117-ファイル一覧)
  - [1.2. レイアウト](#12-レイアウト)
    - [1.2.1. 画面イメージ（現行）](#121-画面イメージ現行)
    - [1.2.2. 画面イメージ（再構築）](#122-画面イメージ再構築)
    - [1.2.3. 画面項目](#123-画面項目)
    - [1.2.4. イベント定義](#124-イベント定義)
  - [1.3. API](#13-api)
    - [1.3.1. API一覧](#131-api一覧)


## 1.1. 処理概要

### 1.1.1. 機能名
| No. | 項目 | 値 |
|:---:|:----------------:|:-------------------:|
| 1 | プロジェクト | meeth様ECサイト開発 |
| 2 | システム | 管理画面 |
| 3 | 画面プログラム | 注文詳細 |
| 4 | 画面プログラムID | M3.2 |
| 5 | 画面フォーム名 | N/A |

### 1.1.2. 機能概要
- 注文詳細情報を表示する。
- 該当の定期購入詳細画面へ遷移する。
- 該当の顧客詳細画面へ遷移する。
- 注文ステータスの履歴を表示する。
- 決済の承認を行う。
- 注文のキャンセルを行う。
- 注文の保留/解除を行う。
- お届け先住所を変更する。
- 領収書を発行する。

### 1.1.3. 前提条件
- ログイン済のユーザであること
- ログインユーザの[権限](https://github.com/grrowjp/Meeth/wiki/%E7%AE%A1%E7%90%86%E7%94%BB%E9%9D%A2%E5%86%8D%E6%A7%8B%E7%AF%89-%E6%A8%A9%E9%99%90%E4%B8%80%E8%A6%A7)が条件を満たしていること(総合管理者、許可された作業担当者のみ閲覧・操作可能)


### 1.1.4. 処理概要
| No  | 操作                                               | 処理概要                                             |
| --- | -------------------------------------------------- | ---------------------------------------------------- |
| 1   | 初期表示時                                         | 注文検索画面にて選択された注文の詳細情報を表示する。 |
| 2   | 「決済承認」ボタン押下時                            | 表示されている注文の決済の承認を行う。                 |
| 3   | 「注文キャンセル」ボタン押下時                      | 表示されている注文のキャンセルを行う。                  |
| 4   | 「保留/解除」ボタン押下時                           | 表示されている注文を保留、または保留の解除を行う。     |
| 5   | 「変更」ボタン押下時                           | お届け先住所の変更を行う。     |
| 6   | 「領収書」リンク押下時                           | 領収書を発行する。     |
| 7   | 定期IDリンク押下時                           | 当該定期購入詳細画面へ遷移する。     |
| 8   | 顧客IDリンク押下時                           | 当該顧客詳細画面へ遷移する。     |

### 1.1.5. パラメータ一覧

| No  | 論理名称 | 物理名称 | I/O | 備考 |
| --- | -------- | -------- | --- | ---- |
| 1   |     注文ID     |    order_id      |   O  |      |

### 1.1.6. テーブル一覧
| No | 論理名称 | 物理名称 | I/O | 備考 |
|----|------------------|-------------------|-----|------|
| 1 | [顧客情報テーブル](https://github.com/grrowjp/Meeth/wiki/%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E5%AE%9A%E7%BE%A9_customers) | customers | O | |
| 2 | [顧客住所テーブル](https://github.com/grrowjp/Meeth/wiki/%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E5%AE%9A%E7%BE%A9_customer_addresses) | customer_addresses | O | |
| 3 | [注文テーブル](https://github.com/grrowjp/Meeth/wiki/%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E5%AE%9A%E7%BE%A9_orders) | subscriptions | O | |
| 4 | [注文詳細テーブル](https://github.com/grrowjp/Meeth/wiki/%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E5%AE%9A%E7%BE%A9_order_details) | subscription_details | O | |
| 5 | [商品テーブル](https://github.com/grrowjp/Meeth/wiki/%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E5%AE%9A%E7%BE%A9_products) | products | O | |
| 6 | [商品詳細テーブル](https://github.com/grrowjp/Meeth/wiki/%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E5%AE%9A%E7%BE%A9_product_details) | product_details | O | |
| 7 | [注文状況履歴テーブル](https://github.com/grrowjp/Meeth/wiki/%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E5%AE%9A%E7%BE%A9_order_status_trails) | order_status_trails | O | |

### 1.1.7. ファイル一覧

| No | 論理名称 | 物理名称 | I/O | 備考 |
|----------------|----------|-----------|-----|------|
| 1 | 領収書 | receipt | O | |

## 1.2. レイアウト
### 1.2.1. 画面イメージ（現行）
![image](https://user-images.githubusercontent.com/77314669/112423445-fcfc1100-8d75-11eb-99b3-b3b3f8fd169f.png)


### 1.2.2. 画面イメージ（再構築）

![image](https://user-images.githubusercontent.com/77314669/115502032-3f4e3a80-a2af-11eb-9fd0-cbd004545f81.png)




### 1.2.3. 画面項目

| No   | 名称                        | 対応DB項目                                                                                                                 | I/O   | 種別     | 型       | 桁数   | 必須   | バリデーション | 備考                                                                                                    |
|------|-----------------------------|----------------------------------------------------------------------------------------------------------------------------|-------|----------|----------|--------|--------|----------------|---------------------------------------------------------------------------------------------------------|
| 1    | 注文ID                      | ー                                                                                                                         | O     | ラベル   | ー       | ー     | ー     | ー             |                                                                                                         |
|      |                             | orders.id                                                                                                                  | O     | テキスト | ー       | ー     | ー     | ー             |                                                                                                         |
| 2    | 定期ID                      | ー                                                                                                                         | O     | リンク   | ー       | ー     | ー     | ー             |                                                                                                         |
|      |                             | orders.subscription_id                                                                                                     | O     | テキスト | ー       | ー     | ー     | ー             | 定期購入詳細画面へのテキストリンク                                                                      |
| 3    | 注文日                      | ー                                                                                                                         | O     | ラベル   | ー       | ー     | ー     | ー             |                                                                                                         |
|      |                             | orders.created_at                                                                                                          | O     | テキスト | ー       | ー     | ー     | ー             |                                                                                                         |
| 4    | ギフトバッグ                | ー                                                                                                                         | O     | ラベル   | ー       | ー     | ー     | ー             |                                                                                                         |
|      |                             | orders.gift_bag                                                                                                            | O     | テキスト | ー       | ー     | ー     | ー             |                                                                                                         |
| 5    | 注文状況                    | ー                                                                                                                         | O     | ラベル   | ー       | ー     | ー     | ー             |                                                                                                         |
|      |                             | orders.status                                                                                                              |       | テキスト | ー       | ー     | ー     | ー             | 詳細は[ステータス一覧](https://github.com/grrowjp/Meeth/wiki/%E7%AE%A1%E7%90%86%E7%94%BB%E9%9D%A2%E5%86%8D%E6%A7%8B%E7%AF%89-%E3%82%B9%E3%83%86%E3%83%BC%E3%82%BF%E3%82%B9%E4%B8%80%E8%A6%A7)を参照 |
| 6    | 決済方法                    | ー                                                                                                                         | O     | ラベル   | ー       | ー     | ー     | ー             |                                                                                                         |
|      |                             | orders.id<br> payments.payment_method                                                                                      | O     | アイコン | ー       | ー     | ー     | ー             | 決済方法を画像アイコンで表示                                                                            |
| 7    | 決済状況                    | ー                                                                                                                         | O     | ラベル   | ー       | ー     | ー     | ー             |                                                                                                         |
|      |                             | orders.id<br> payments.status                                                                                              | O     | テキスト | ー       | ー     | ー     | ー             | 詳細は[ステータス一覧](https://github.com/grrowjp/Meeth/wiki/%E7%AE%A1%E7%90%86%E7%94%BB%E9%9D%A2%E5%86%8D%E6%A7%8B%E7%AF%89-%E3%82%B9%E3%83%86%E3%83%BC%E3%82%BF%E3%82%B9%E4%B8%80%E8%A6%A7)を参照 |
| 8    | 商品合計                    | ー                                                                                                                         | O     | ラベル   | ー       | ー     | ー     | ー             |                                                                                                         |
|      |                             | orders.total_amount                                                                                                        | O     | テキスト | ー       | ー     | ー     | ー             |                                                                                                         |
| 9    | 税                          | ー                                                                                                                         | O     | ラベル   | ー       | ー     | ー     | ー             |                                                                                                         |
|      |                             | orders_detail.tax_rate                                                                                                     | O     | テキスト | ー       | ー     | ー     | ー             |                                                                                                         |
| 10   | 配送料                      | ー                                                                                                                         | O     | ラベル   | ー       | ー     | ー     | ー             |                                                                                                         |
|      |                             | orders.fee                                                                                                                 | O     | テキスト | ー       | ー     | ー     | ー             |                                                                                                         |
| 11   | 請求金額                    | ー                                                                                                                         | O     | ラベル   | ー       | ー     | ー     | ー             |                                                                                                         |
|      |                             |       orders.total_amount<br>orders_detail.tax_rate<br>orders.fee                                                                                                  | O     | テキスト | ー       | ー     | ー     | ー             |       プログラムにて計算                                                                                                  |
| 12   | 注文商品                    | ー                                                                                                                         | O     | ラベル   | ー       | ー     | ー     | ー             |                                                                                                         |
|      |                             | products.id                                                                                                                | O     | テキスト | ー       | ー     | ー     | ー             |                                                                                                         |
|      |                             | products.name                                                                                                              | O     | テキスト | ー       | ー     | ー     | ー             |                                                                                                         |
|      |                             | product_detail.quantity                                                                                                    | O     | テキスト | ー       | ー     | ー     | ー             |                                                                                                         |
| 13   | 決済承認                    | ー                                                                                                                         | O     | ボタン   | ー       | ー     | ー     | ー             |                                                                                                         |
| 14   | 注文キャンセル              | ー                                                                                                                         | O     | ボタン   | ー       | ー     | ー     | ー             |                                                                                                         |
| 15   | 保留/解除                   | ー                                                                                                                         | O     | ボタン   | ー       | ー     | ー     | ー             |                                                                                                         |
| 18   | 顧客ID                      | ー                                                                                                                         | O     | ラベル   | ー       | ー     | ー     | ー             |                                                                                                         |
|      |                             | customers.id                                                                                                               | O     | テキスト | ー       | ー     | ー     | ー             |                                                                                                         |
| 19   | 顧客氏名                    | ー                                                                                                                         | O     | ラベル   | ー       | ー     | ー     | ー             |                                                                                                         |
|      |                             | customers.name                                                                                                             | O     | テキスト | ー       | ー     | ー     | ー             |                                                                                                         |
| 20   | メールアドレス              | ー                                                                                                                         | O     | ラベル   | ー       | ー     | ー     | ー             |                                                                                                         |
|      |                             | customers.email                                                                                                            | O     | テキスト | ー       | ー     | ー     | ー             |                                                                                                         |
| 21   | お届け先住所                | ー                                                                                                                         | O     | ラベル   | ー       | ー     | ー     | ー             |                                                                                                         |
|      |                             | customer_addresses.family_name<br>customer_addresses.first_name                                                            | O     | テキスト | ー       | ー     | ー     | ー             |                                                                                                         |
| 22   |                             | customer_addresses.zip_code                                                                                                | O     | テキスト | ー       | ー     | ー     | ー             |                                                                                                         |
| 23   |                             | customer_addresses.prefecture                                                                                              | O     | テキスト | ー       | ー     | ー     | ー             |                                                                                                         |
|      |                             | customer_addresses.prefecture<br>customer_addresses.address1<br>customer_addresses.address2<br>customer_addresses.address3 | O     | テキスト | ー       | ー     | ー     | ー             |                                                                                                         |
| 24   |                             | customer_addresses.phone                                                                                                   | O     | テキスト | ー       | ー     | ー     | ー             |                                                                                                         |
| 25   | お届け先の変更              | ー                                                                                                                         | O     | ボタン   | ー       | ー     | ー     | ー             |   注文状況が未発送の場合のみボタンが出現する                                                                                                      |
| 26   | ステータス履歴              | ー                                                                                                                         | O     | ラベル   | ー       | ー     | ー     | ー             |                                                                                                         |
| 27   |                             | order_status_trails.created_at                                                                                             | O     | テキスト | ー       | ー     | ー     | ー             |                                                                                                         |
|      |                             | order_status_trails.after_status<br>order_status_trails.note                                                               | O     | テキスト | ー       | ー     | ー     | ー             |                                                                                                         |
| 28   | 領収書発行                  | ー                                                                                                                         | O     | リンク   | ー       | ー     | ー     | ー             | 注文状況が発送完了の場合のみリンクが出現する                                                                                                        |

### 1.2.4. イベント定義

| No  | 項目            | 発生条件 | 遷移先         | 備考                              | API |
| --- | --------------- | -------- | -------------- | --------------------------------- | -- |
| 1   | 初期表示      | － | － |                                   | 注文詳細情報取得API |
| 1   | 「決済承認」ボタン            | クリック | [注文詳細.決済承認モーダル](https://github.com/grrowjp/Meeth/wiki/%E7%AE%A1%E7%90%86%E7%94%BB%E9%9D%A2%E5%86%8D%E6%A7%8B%E7%AF%89-0035.M35:%E6%B3%A8%E6%96%87%E8%A9%B3%E7%B4%B0.%E6%B1%BA%E6%B8%88%E6%89%BF%E8%AA%8D%E3%83%BB%E7%99%BA%E9%80%81%E5%87%A6%E7%90%86%E9%96%8B%E5%A7%8B-%E5%AE%8C%E4%BA%86_ver2.0)             |  表示されている注文の決済の承認を行う。  | |
| 2   | 「注文キャンセル」ボタン | クリック | [注文詳細.注文詳細モーダル](https://github.com/grrowjp/Meeth/wiki/%E7%AE%A1%E7%90%86%E7%94%BB%E9%9D%A2%E5%86%8D%E6%A7%8B%E7%AF%89-0034.M3.4:%E6%B3%A8%E6%96%87%E8%A9%B3%E7%B4%B0.%E6%B3%A8%E6%96%87%E3%82%AD%E3%83%A3%E3%83%B3%E3%82%BB%E3%83%AB%E3%83%BB%E4%BF%9D%E7%95%99-%E8%A7%A3%E9%99%A4_ver2.0)             | 表示されている注文のキャンセルを行う。 ||
| 3   | 「保留/解除」ボタン | クリック | [注文詳細.保留・保留解除モーダル](https://github.com/grrowjp/Meeth/wiki/%E7%AE%A1%E7%90%86%E7%94%BB%E9%9D%A2%E5%86%8D%E6%A7%8B%E7%AF%89-0034.M3.4:%E6%B3%A8%E6%96%87%E8%A9%B3%E7%B4%B0.%E6%B3%A8%E6%96%87%E3%82%AD%E3%83%A3%E3%83%B3%E3%82%BB%E3%83%AB%E3%83%BB%E4%BF%9D%E7%95%99-%E8%A7%A3%E9%99%A4_ver2.0)            | 表示されている注文を保留、または保留の解除を行う。 ||
| 4   | 「変更」ボタン      | クリック | [注文詳細.お届け先住所変更モーダル](https://github.com/grrowjp/Meeth/wiki/%E7%AE%A1%E7%90%86%E7%94%BB%E9%9D%A2%E5%86%8D%E6%A7%8B%E7%AF%89-0033.M3.3:%E3%81%8A%E5%B1%8A%E3%81%91%E5%85%88%E9%81%B8%E6%8A%9E_ver2.0) |  お届け先住所の変更を行う。                                 |  |
| 5   | 領収書」リンク          | クリック | [領収書画面](https://github.com/grrowjp/Meeth/wiki/%E7%AE%A1%E7%90%86%E7%94%BB%E9%9D%A2%E5%86%8D%E6%A7%8B%E7%AF%89-0036.M36:%E6%B3%A8%E6%96%87%E8%A9%B3%E7%B4%B0.%E9%A0%98%E5%8F%8E%E6%9B%B8_ver2.0)    |  領収書を発行する                                 ||
| 6   | 定期IDリンク          | クリック | [定期購入詳細画面](https://github.com/grrowjp/Meeth/wiki/%E7%AE%A1%E7%90%86%E7%94%BB%E9%9D%A2%E5%86%8D%E6%A7%8B%E7%AF%89-0042.M4.2:%E5%AE%9A%E6%9C%9F%E8%B3%BC%E5%85%A5%E8%A9%B3%E7%B4%B0_ver2.0)   |  当該定期購入詳細画面に遷移する                                 ||
| 7   | 顧客IDリンク          | クリック | [顧客詳細画面](https://github.com/grrowjp/Meeth/wiki/%E7%AE%A1%E7%90%86%E7%94%BB%E9%9D%A2%E5%86%8D%E6%A7%8B%E7%AF%89-0061.M6.2:%E9%A1%A7%E5%AE%A2%E8%A9%B3%E7%B4%B0_ver2.0)   |  当該顧客詳細画面に遷移する                                 ||


## 1.3. API

### 1.3.1. API一覧

| NO. | 名称 | 内容 |
|-|-|-|
| 1 | 注文詳細情報取得API | 注文詳細情報を取得する |

