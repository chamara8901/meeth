# 1. [管理画面再構築](https://github.com/grrowjp/Meeth/wiki/%E7%AE%A1%E7%90%86%E7%94%BB%E9%9D%A2%E5%86%8D%E6%A7%8B%E7%AF%89-%E7%94%BB%E9%9D%A2%E4%B8%80%E8%A6%A7%28ver2.0%29) - M6.1:顧客管理 機能設計書

- [1. 管理画面再構築 - M6.1:顧客管理 機能設計書](#1-管理画面再構築---m61顧客管理-機能設計書)
  - [1.1. 処理概要](#11-処理概要)
    - [1.1.1. 機能名](#111-機能名)
    - [1.1.2. 機能概要](#112-機能概要)
    - [1.1.3. 前提条件](#113-前提条件)
    - [1.1.4. 処理概要](#114-処理概要)
    - [1.1.5. パラメータ一覧](#115-パラメータ一覧)
    - [1.1.6. テーブル一覧](#116-テーブル一覧)
    - [1.1.7. ファイル一覧](#117-ファイル一覧)
  - [1.2. レイアウト](#12-レイアウト)
    - [1.2.1. 旧仕様](#121-旧仕様)
    - [1.2.2. 画面イメージ](#122-画面イメージ)
    - [1.2.3. 画面項目](#123-画面項目)
    - [1.2.4. イベント定義](#124-イベント定義)
  - [1.3. API](#13-api)
    - [1.3.1. API一覧](#131-api一覧)


## 1.1. 処理概要

### 1.1.1. 機能名

|  No.  |       項目       |         値          |
| :---: | :--------------: | :-----------------: |
|   1   |   プロジェクト   | meeth様ECサイト開発 |
|   2   |     システム     |      管理画面       |
|   3   |  画面プログラム  |      顧客管理       |
|   4   | 画面プログラムID |        M6.1         |
|   5   |  画面フォーム名  |      顧客検索       |

### 1.1.2. 機能概要
- 検索
  - 顧客ID・名前・メールアドレス、年代、誕生月、DM可否、注文数(以下・一致・以上で絞り込み)、定期購入注文数(以下・一致・以上で絞り込み)、商品購入金額(以下・一致・以上で絞り込み)、定期購入金額(以下・一致・以上で絞り込み)、最終注文日、お届け先の名前、郵便番号、住所情報でAND検索する
  - お届け先検索については、デフォルトだけではなくお届け先に登録されている全てのお届け先から検索する
- 顧客情報を表示する
  - 顧客ID、名前、年齢、メールアドレス、注文数、定期注文数、商品購入金額、定期購入金額、定期購入状況、最終注文日を表示する
- 顧客情報をCSVファイルにてエクスポートする (※要件調整中)
  - 現在一覧表示されている総件数分CSVエクスポートする
  - お届け先を複数持つ顧客については複数レコード作成する
- 顧客詳細画面に遷移する

### 1.1.3. 前提条件
- ログイン済のユーザであること
- ログインユーザの[権限](https://github.com/grrowjp/Meeth/wiki/%E7%AE%A1%E7%90%86%E7%94%BB%E9%9D%A2%E5%86%8D%E6%A7%8B%E7%AF%89-%E6%A8%A9%E9%99%90%E4%B8%80%E8%A6%A7)が条件を満たしていること(総合管理者、許可された作業担当者のみ閲覧・操作可能)


### 1.1.4. 処理概要
| No 	| 操作 	| 処理概要 	|
|-	|-	|-	|
| 1 	| 初期表示時 	| 全顧客を表示する。顧客数の表示件数は100件単位とする。 	|
| 2 	| 1.「検索：顧客ID・名前・メールアドレス」項目にテキスト入力<br>2. 検索ボタンを押下 	| 顧客IDには完全一致、名前・メールアドレスには部分一致となる顧客を表示する。 	|
| 3 	| 1.「検索：年代」プルダウン選択<br>2. 検索ボタンを押下 	| 選択した年代に該当する顧客を表示する。 	|
| 4 	| 1.「検索：誕生月」プルダウン選択<br>2. 検索ボタンを押下 	| 選択した誕生月に該当する顧客を表示する。 	|
| 5 	| 1.「検索：DM可否」プルダウン選択<br>2. 検索ボタンを押下 	| 選択したDM可否に該当する顧客を表示する。 	|
| 6 	| 1.「検索：注文数」を入力する。<br>2. 以下、一致、以上いずれかを選択する。<br>3. 検索ボタンを押下 	| 選択した注文数に該当する顧客を表示する。 	|
| 7 	| 1.「検索：定期購入注文数」を入力する。<br>2. 以下、一致、以上いずれかを選択する。<br>3. 検索ボタンを押下 	| 選択した定期購入注文数に該当する顧客を表示する。 	|
| 8 	| 1.「検索：商品購入金額」を入力する。<br>2. 以下、一致、以上いずれかを選択する。<br>3. 検索ボタンを押下 	| 選択した購入金額に該当する顧客を表示する。 	|
| 9 	| 1.「検索：定期購入金額」を入力する。<br>2. 以下、一致、以上いずれかを選択する。<br>3. 検索ボタンを押下 	| 選択した定期購入金額に該当する顧客を表示する。 	|
| 9 	| 1.「検索：最終注文日」を入力する。<br>2. 検索ボタンを押下 	| 選択した最終注文日に該当する顧客を表示する。 	|
| 10 	| 1.「検索：名前（お届け先）」テキスト入力<br>2. 検索ボタンを押下 	| 入力文字に該当する顧客を表示する。 	|
| 11 	| 1.「検索：郵便番号（お届け先）」テキスト入力<br>2. 検索ボタンを押下 	| 入力文字に該当する顧客を表示する。 	|
| 12 	| 1.「検索：国・都道府県（お届け先）」プルダウン選択<br>2. 検索ボタンを押下 	| 選択した国・都道府県に該当する顧客を表示する。 	|
| 13 	| 1.「検索：その他住所（お届け先）」テキスト入力<br>2. 検索ボタンを押下 	| 入力文字に該当する顧客を表示する。 	|
| 14 	| 1.「CSVダウンロード」押下<br>2. 検索ボタンを押下 	| 検索結果に応じたCSVをエクスポートする。 	|
| 15 	| 顧客ID押下 	| 顧客詳細画面に遷移する。 	|

### 1.1.5. パラメータ一覧

なし

### 1.1.6. テーブル一覧

| No  | 論理名称                                                                                                                               | 物理名称           | I/O | 備考 |
| --- | -------------------------------------------------------------------------------------------------------------------------------------- | ------------------ | --- | ---- |
| 1   | [顧客情報テーブル](https://github.com/grrowjp/Meeth/wiki/%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E5%AE%9A%E7%BE%A9_customers)             | customers          | O   |      |
| 2   | [顧客住所テーブル](https://github.com/grrowjp/Meeth/wiki/%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E5%AE%9A%E7%BE%A9_customer_addresses)    | customer_addresses | O   |      |
| 3   | [定期注文基本情報テーブル](https://github.com/grrowjp/Meeth/wiki/%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E5%AE%9A%E7%BE%A9_subscriptions) | subscriptions      | O   |      |
| 4   | [注文テーブル](https://github.com/grrowjp/Meeth/wiki/%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E5%AE%9A%E7%BE%A9_orders)                    | orders             | O   |      |

### 1.1.7. ファイル一覧

| No  | 論理名称            | 物理名称                            | I/O | 備考 |
| --- | ------------------- | ----------------------------------- | --- | ---- |
| 1   | 顧客管理CSVファイル | customers_report_yyyymmddhhmmss.csv | O   |  現在要件調整中    |
| 2   |                     |                                     |     |      |

## 1.2. レイアウト

### 1.2.1. [旧仕様](https://github.com/grrowjp/Meeth/wiki/%E7%AE%A1%E7%90%86%E7%94%BB%E9%9D%A2%E5%86%8D%E6%A7%8B%E7%AF%89-0061.M6.1:%E9%A1%A7%E5%AE%A2%E7%AE%A1%E7%90%86_ver1.0)


### 1.2.2. 画面イメージ
![image](https://user-images.githubusercontent.com/77314669/116350380-cdd13780-a82c-11eb-8cdc-ce6d8f4cdc89.png)








### 1.2.3. 画面項目

| No | 名称                               | 対応DB項目                                    | I/O | 種別             | 型                | 桁数 | 必須(YES/NO) | バリデーション                | 備考                                                                                                                                                                                              |
|----|------------------------------------|-----------------------------------------------|-----|------------------|-------------------|------|--------------|-------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 1  | ページタイトル                     | －                                            | O   | ラベル           | －                | －   | －           |                               |                                                                                                                                                                                                   |
| 2  | ユーザーID                         | －                                            | O   | ラベル           | －                | －   | －           |                               |                                                                                                                                                                                                   |
| 3  | 検索：顧客ID・名前・メールアドレス | －                                            | O   | ラベル           | －                | －   | －           |                               |                                                                                                                                                                                                   |
|    |                                    |                                               | I   | テキストボックス | string            | 255  | NO           | 桁数上限制限                  | 顧客IDは完全一致<br>名前とメールアドレスは部分一致で検索する                                                                                                                                      |
| 4  | 検索：年代                         | －                                            | O   | ラベル           | －                | －   | －           |                               |                                                                                                                                                                                                   |
|    |                                    |                                               | I   | プルダウン       | integer<br>number | 2    | NO           | 型一致型一致<br> 桁数上限制限 | 【10歳代,20歳代,30歳代,40歳代,50歳代,60歳代,70歳代,80歳代,90歳代】から選択する                                                                                                                    |
| 5  | 検索：誕生月                       | －                                            | O   | ラベル           | －                | －   | －           |                               |                                                                                                                                                                                                   |
|    |                                    |                                               | I   | プルダウン       | integer<br>number | 2    | NO           | 型一致<br> 桁数上限制限       | 【1月,2月,3月,4月,5月,6月,7月,8月,9月,10月,11月,12月】から選択する                                                                                                                                |
| 6  | 検索：DM可否                       | －                                            | O   | ラベル           | －                | －   | －           |                               |                                                                                                                                                                                                   |
|    |                                    |                                               | I   | プルダウン       | boolean           | －   | NO           |                               | 【許可,拒否】から選択する                                                                                                                                                                         |
| 7  | 検索：注文数                       | －                                            | O   | ラベル           | －                | －   | －           |                               |                                                                                                                                                                                                   |
|    |                                    |                                               | I   | テキストボックス | integer<br>number | －   | NO           | 自然数                        |                   下限                                                                                                                                                                                |
|    |                                    |                                               | I   | テキストボックス | integer<br>number | －   | NO           | 自然数                        |                     上限                                                                                                                                                                              |
| 8  | 検索：定期購入注文数               | －                                            | O   | ラベル           | －                | －   | －           |                               |                                                                                                                                                                                                   |
|    |                                    |                                               | I   | テキストボックス | integer<br>number | －   | NO           | 自然数                        |                     下限                                                                                                                                                                              |
|    |                                    |                                               | I   | テキストボックス | integer<br>number | －   | NO           | 自然数                        |                       上限                                                                                                                                                                            |
| 9  | 検索：商品購入金額                 | －                                            | O   | ラベル           | －                | －   | －           |                               |                                                                                                                                                                                                   |
|    |                                    |                                               | I   | テキストボックス | integer<br>number | －   | NO           | 自然数                        |                        下限                                                                                                                                                                           |
|    |                                    |                                               | I   | テキストボックス | integer<br>number | －   | NO           | 自然数                        |                         上限                                                                                                                                                                          |
| 10 | 検索：定期購入金額                 | －                                            | O   | ラベル           | －                | －   | －           |                               |                                                                                                                                                                                                   |
|    |                                    |                                               | I   | テキストボックス | integer<br>number | －   | NO           | 自然数                        |                          下限                                                                                                                                                                         |
|    |                                    |                                               | I   | テキストボックス | integer<br>number | －   | NO           | 自然数                        |                          上限                                                                                                                                                                         |
| 11 | 検索：最終注文日                   | －                                            | I   | ボタン           | －                | －   | NO           |                               | カレンダーアイコン押下でカレンダーがポップアップ表示され、カレンダー内の日付を選択することでフォーム部分に日付が反映される<br> フォーム部分に直接入力は不可だが、反映された日付の削除は可能とする |
| 12 | 検索：お届け先                     |                                               | O   | ラベル           | －                | －   | －           |                               |                                                                                                                                                                                                   |
|    | 検索：名前（お届け先）             | －                                            | O   | ラベル           | －                | －   | －           |                               |                                                                                                                                                                                                   |
|    |                                    |                                               | I   | テキストボックス | string            | 100  | NO           | 桁数上限制限                  |                                                                                                                                                                                                   |
| 13 | 検索：郵便番号（お届け先）         | －                                            | O   | ラベル           | －                | －   | －           |                               |                                                                                                                                                                                                   |
|    |                                    |                                               | I   | テキストボックス | string            | 10   | NO           | 桁数上限制限                  |                                                                                                                                                                                                   |
| 14 | 検索：国（お届け先）               | －                                            | O   | ラベル           | －                | －   | －           |                               |                                                                                                                                                                                                   |
|    |                                    |                                               | I   | プルダウン       | string            | 10   | NO           | 桁数上限制限                  | 国名を選択時、選択した国に応じて都道府県の表示内容が変動するようにする                                                                                                                            |
| 15 | 検索：都道府県（お届け先）         | －                                            | O   | ラベル           | －                | －   | －           |                               | 国名を選択時、選択した国に応じて表示内容が変動するようにする(日本であれば都道府県、アメリカであれば州になるなど)                                                                                  |
|    |                                    |                                               | I   | プルダウン       | string            | 10   | NO           | 桁数上限制限                  | 国名を選択時、選択した国に応じて表示内容が変動するようにする                                                                                                                                      |
| 16 | 検索：その他住所（お届け先）       | －                                            | O   | ラベル           | －                | －   | －           |                               |                                                                                                                                                                                                   |
|    |                                    |                                               | I   | テキストボックス | string            | 255  | NO           | 桁数上限制限                  |                                                                                                                                                                                                   |
| 17 | 検索：電話番号（お届け先）         | －                                            | O   | ラベル           | －                | －   | －           |                               |                                                                                                                                                                                                   |
|    |                                    |                                               | I   | テキストボックス | integer<br>number | 20   | NO           | 自然数                        |                                                                                                                                                                                                   |
| 18 | 検索                               | －                                            | I   | ボタン           | －                | －   | －           |                               |                                                                                                                                                                                                   |
| 19 | CSVダウンロード                    | －                                            | I   | ボタン           | －                | －   | －           |                               |                                                                                                                                                                                                   |
| 20 | 件数表示                           | －                                            | O   | ラベル           | －                | －   | －           |                               |                                                                                                                                                                                                   |
| 21 | ページャー                         | －                                            | I   | リンク           | －                | －   | －           |                               |                                                                                                                                                                                                   |
| 22 | 顧客ID                             | －                                            | O   | ラベル           | －                | －   | －           |                               |                                                                                                                                                                                                   |
|    |                                    | customers.id                                  | O   | リンク           | －                | －   | －           |                               |                                                                                                                                                                                                   |
| 23 | 名前                               | －                                            | O   | ラベル           | －                | －   | －           |                               |                                                                                                                                                                                                   |
|    |                                    | customers.family_name<br>customers.first_name | O   | テキスト         | －                | －   | －           |                               |                                                                                                                                                                                                   |
| 24 | 年齢                               | －                                            | O   | ラベル           | －                | －   | －           |                               |                                                                                                                                                                                                   |
|    |                                    | customers.birthday                            | O   | テキスト         | －                | －   | －           |                               |                                                                                                                                                                                                   |
| 25 | メールアドレス                     | －                                            | O   | ラベル           | －                | －   | －           |                               |                                                                                                                                                                                                   |
|    |                                    | customers.email                               | O   | テキスト         | －                | －   | －           |                               |                                                                                                                                                                                                   |
| 26 | 注文数（定期）                     | －                                            | O   | ラベル           | －                | －   | －           |                               | orders.statusが3（完了）のidをカウントする                                                                                                                                                        |
|    |                                    | orders.id                                     | O   | テキスト         | －                | －   | －           |                               |                                                                                                                                                                                                   |
| 27 | 商品購入金額（定期）               | －                                            | O   | ラベル           | －                | －   | －           |                               | orders.statusが3（完了）のtotal_amountを表示する                                                                                                                                                  |
|    |                                    | orders.total_amount                           | O   | テキスト         | －                | －   | －           |                               |                                                                                                                                                                                                   |
| 28 | 定期購入                           | －                                            | O   | ラベル           | －                | －   | －           |                               | subscriptions.processing_status=<br>1（処理中）<br>2（次回準備中）<br>3（一時停止）<br>の場合、「契約中」<br>subscriptions.processing_status=<br>4（解約）<br>の場合、「解約」を表示する          |
|    |                                    | subscriptions.processing_status               | O   | テキスト         | －                | －   | －           |                               | 定期購入がない場合は「ー」を表示する                                                                                                                                                              |
| 29 | 最終注文日                         | －                                            | O   | ラベル           | －                | －   | －           |                               | orders.statusが3（完了）の場合のみ表示する                                                                                                                                                        |
|    |                                    | orders.updated_at                             | O   | テキスト         | －                | －   | －           |                               |                                                                                                                                                                                                   |

### 1.2.4. イベント定義

| No  | 項目            | 発生条件 | 遷移先         | 備考                              |API                              |
| --- | --------------- | -------- | -------------- | --------------------------------- |---- |
| 1   | 検索            | クリック | －             | 検索条件に応じた検索結果を表示    | 検索API<br>件数取得API |
| 2   | CSVダウンロード | クリック | －             | 検索条件に応じたCSVをエクスポート | CSVダウンロードAPI |
| 3   | ページャー      | クリック | 指定したページ |                                   |  |
| 4   | 顧客ID          | クリック | [顧客詳細画面](https://github.com/grrowjp/Meeth/wiki/%E7%AE%A1%E7%90%86%E7%94%BB%E9%9D%A2%E5%86%8D%E6%A7%8B%E7%AF%89-0061.M6.2:%E9%A1%A7%E5%AE%A2%E8%A9%B3%E7%B4%B0_ver2.0)   |                                   | |

## 1.3. API

### 1.3.1. API一覧

| NO. | 名称                                                                                                                                                                                                                          | 内容                                                                         |
| --- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------- |
| 1   | [検索API](https://github.com/grrowjp/Meeth/wiki/%E7%AE%A1%E7%90%86%E7%94%BB%E9%9D%A2%E5%86%8D%E6%A7%8B%E7%AF%89-%E9%A1%A7%E5%AE%A2%E7%AE%A1%E7%90%86-%E6%A4%9C%E7%B4%A2API)                                                   | 受け取った検索パラメータから検索結果を返却するAPI                            |
| 2   | [件数取得API](https://github.com/grrowjp/Meeth/wiki/%E7%AE%A1%E7%90%86%E7%94%BB%E9%9D%A2%E5%86%8D%E6%A7%8B%E7%AF%89-%E9%A1%A7%E5%AE%A2%E7%AE%A1%E7%90%86-%E4%BB%B6%E6%95%B0%E5%8F%96%E5%BE%97API)                             | 総件数を取得し返却するAPI                                                    |
| 3   | [CSVダウンロードAPI](https://github.com/grrowjp/Meeth/wiki/%E7%AE%A1%E7%90%86%E7%94%BB%E9%9D%A2%E5%86%8D%E6%A7%8B%E7%AF%89-%E9%A1%A7%E5%AE%A2%E7%AE%A1%E7%90%86-CSV%E3%83%80%E3%82%A6%E3%83%B3%E3%83%AD%E3%83%BC%E3%83%89API) | 受け取った検索パラメータからCSVダウンロード処理を行い、バリデーションエラー時はエラーを返却するAPI |

